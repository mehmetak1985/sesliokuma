<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sesli Okuma Oyunu</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #0f1b2d;
    --surface:  #1a2d46;
    --surface2: #223558;
    --accent:   #ffd166;
    --red:      #ef476f;
    --green:    #06d6a0;
    --yellow:   #ffd166;
    --text:     #e8f4fd;
    --text-muted: #7fa8c9;
    --radius: 20px;
    --shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Baloo 2', cursive;
    background: var(--bg);
    min-height: 100vh;
    display: grid;
    place-items: center;
    overflow: hidden;
    position: relative;
  }

  /* â”€â”€ YÄ±ldÄ±z arka planÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
  .star {
    position: absolute;
    border-radius: 50%;
    background: white;
    animation: twinkle var(--d, 3s) ease-in-out infinite var(--delay, 0s);
    opacity: 0.3;
    will-change: opacity, transform;
  }
  @keyframes twinkle {
    0%, 100% { opacity: 0.1; transform: scale(0.8); }
    50%       { opacity: 0.7; transform: scale(1.2); }
  }

  /* â”€â”€ Oyun kabÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .game-container {
    position: relative;
    z-index: 1;
    width: min(90vw, 700px);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding: 24px 0;
  }

  /* â”€â”€ BaÅŸlÄ±k â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .title-area { text-align: center; }
  .title-area h1 {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(1.6rem, 5vw, 2.6rem);
    color: var(--accent);
    text-shadow: 0 0 20px rgba(255,209,102,0.4), 0 4px 8px rgba(0,0,0,0.5);
  }
  .subtitle { font-size: 0.9rem; color: var(--text-muted); margin-top: 4px; }
  .sentence-badge {
    display: inline-block;
    font-size: 0.8rem;
    color: var(--text-muted);
    background: var(--surface2);
    padding: 4px 14px;
    border-radius: 20px;
    margin-top: 6px;
  }

  /* â”€â”€ Skor kartÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .score-card {
    background: var(--surface);
    border: 2px solid var(--surface2);
    border-radius: var(--radius);
    padding: 12px 32px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: var(--shadow);
  }
  .score-icon  { font-size: 1.6rem; }
  .score-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
  .score-value {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 2rem;
    color: var(--accent);
    line-height: 1;
    will-change: transform;
  }
  .score-value.bump { animation: scoreBump 0.3s ease; }
  @keyframes scoreBump {
    0%   { transform: scale(1); }
    50%  { transform: scale(1.4); color: #fff; }
    100% { transform: scale(1); }
  }

  /* â”€â”€ Kelime kartÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .word-card {
    background: var(--surface);
    border: 2px solid var(--surface2);
    border-radius: var(--radius);
    padding: 28px 32px;
    width: 100%;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    min-height: 110px;
  }

  .word {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(1.6rem, 6vw, 3rem);
    padding: 6px 14px;
    border-radius: 12px;
    border: 3px solid transparent;
    transition: color 0.2s ease, background 0.2s ease, border-color 0.2s ease;
    cursor: default;
    letter-spacing: 0.5px;
    color: var(--text);
    background: transparent;
    will-change: transform;
  }
  .word.active {
    background: rgba(255,209,102,0.15);
    border-color: var(--yellow);
    color: var(--yellow);
    transform: scale(1.08);
    box-shadow: 0 0 20px rgba(255,209,102,0.3);
    animation: pulse 1.2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 20px rgba(255,209,102,0.3); }
    50%       { box-shadow: 0 0 36px rgba(255,209,102,0.6); }
  }
  .word.correct {
    background: rgba(6,214,160,0.15);
    border-color: var(--green);
    color: var(--green);
    animation: correctPop 0.4s ease forwards;
  }
  @keyframes correctPop {
    0%   { transform: scale(1); }
    40%  { transform: scale(1.15) rotate(-2deg); }
    70%  { transform: scale(0.97) rotate(1deg); }
    100% { transform: scale(1) rotate(0deg); }
  }
  .word.wrong {
    background: rgba(239,71,111,0.15);
    border-color: var(--red);
    color: var(--red);
    animation: shake 0.4s ease;
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%  { transform: translateX(-6px); }
    40%  { transform: translateX(6px); }
    60%  { transform: translateX(-4px); }
    80%  { transform: translateX(4px); }
  }

  /* â”€â”€ Mikrofon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mic-area { display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .mic-indicator {
    width: 72px; height: 72px;
    border-radius: 50%;
    background: var(--surface);
    border: 3px solid var(--surface2);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem;
    transition: background 0.3s, border-color 0.3s;
    box-shadow: var(--shadow);
  }
  .mic-indicator.active {
    background: rgba(239,71,111,0.15);
    border-color: var(--red);
    animation: micPulse 1s ease-in-out infinite;
  }
  @keyframes micPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239,71,111,0.4); }
    50%       { box-shadow: 0 0 0 14px rgba(239,71,111,0); }
  }
  .mic-status { font-size: 0.85rem; color: var(--text-muted); text-align: center; min-height: 20px; transition: color 0.3s; }
  .mic-status.listening { color: var(--red); }

  /* â”€â”€ Interim metin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .interim-text {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-style: italic;
    min-height: 20px;
    text-align: center;
    max-width: 500px;
  }

  /* â”€â”€ Butonlar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .button-row { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }
  .btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.05rem;
    padding: 13px 32px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 4px 14px rgba(0,0,0,0.3);
    letter-spacing: 0.5px;
    touch-action: manipulation;
  }
  .btn:active { transform: scale(0.96); }
  .btn-start { background: linear-gradient(135deg, var(--green), #04b88a); color: #0a2a1f; }
  .btn-start:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(6,214,160,0.4); }
  .btn-stop  { background: linear-gradient(135deg, var(--red), #d63060); color: #fff; }
  .btn-stop:hover:not(:disabled)  { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(239,71,111,0.4); }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; box-shadow: none; }

  /* â”€â”€ Tebrik banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .congrats-banner {
    display: none;
    background: linear-gradient(135deg, #ffd166, #ff9f1c);
    color: #1a0a00;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(1.2rem, 4vw, 1.8rem);
    padding: 16px 32px;
    border-radius: var(--radius);
    text-align: center;
    width: 100%;
    box-shadow: 0 8px 32px rgba(255,209,102,0.5);
  }
  .congrats-banner.visible {
    display: block;
    animation: congratsIn 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
  }
  @keyframes congratsIn {
    0%   { transform: scale(0.5) rotate(-4deg); opacity: 0; }
    100% { transform: scale(1) rotate(0deg);    opacity: 1; }
  }

  /* â”€â”€ Hata ve destek mesajlarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .error-msg {
    display: none;
    color: var(--red);
    font-size: 0.9rem;
    text-align: center;
    background: rgba(239,71,111,0.1);
    border: 1px solid rgba(239,71,111,0.3);
    border-radius: 12px;
    padding: 10px 20px;
    width: 100%;
  }
  .error-msg.visible { display: block; }
  .no-support { display: none; color: var(--accent); text-align: center; font-size: 1.1rem; padding: 20px; }
  .no-support.visible { display: block; }
</style>
</head>
<body>

<div class="stars" id="stars"></div>

<div class="game-container">
  <div class="title-area">
    <h1>ğŸŒŸ Sesli Okuma Oyunu</h1>
    <p class="subtitle">Kelimeyi sesli oku ve puan kazan!</p>
    <span class="sentence-badge" id="sentenceBadge">CÃ¼mle 1 / 6</span>
  </div>

  <div class="score-card">
    <span class="score-icon">â­</span>
    <div>
      <div class="score-label">Puan</div>
      <div class="score-value" id="scoreDisplay">0</div>
    </div>
  </div>

  <div class="word-card" id="wordCard"></div>

  <div class="mic-area">
    <div class="mic-indicator" id="micIndicator">ğŸ¤</div>
    <div class="mic-status"    id="micStatus">BaÅŸlamak iÃ§in dÃ¼ÄŸmeye bas</div>
  </div>

  <div class="interim-text" id="interimText"></div>

  <div class="button-row">
    <button class="btn btn-start" id="btnStart">â–¶ BaÅŸla</button>
    <button class="btn btn-stop"  id="btnStop" disabled>ğŸ”„ Tekrar</button>
  </div>

  <div class="congrats-banner" id="congratsBanner"></div>
  <div class="error-msg"       id="errorMsg"></div>
  <div class="no-support"      id="noSupport">
    ğŸ˜” TarayÄ±cÄ±n sesli tanÄ±ma Ã¶zelliÄŸini desteklemiyor. LÃ¼tfen Google Chrome kullan.
  </div>
</div>

<script>
"use strict";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YILDIZ ARKAPLAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const el   = document.getElementById('stars');
  const frag = document.createDocumentFragment();
  for (let i = 0; i < 80; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const b = Math.random() * 3 + 1;
    s.style.cssText =
      `width:${b}px;height:${b}px;` +
      `left:${Math.random()*100}%;top:${Math.random()*100}%;` +
      `--d:${(2 + Math.random()*4).toFixed(1)}s;` +
      `--delay:-${(Math.random()*5).toFixed(1)}s;`;
    frag.appendChild(s);
  }
  el.appendChild(frag);
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TARAYICI DESTEÄÄ°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  document.getElementById('noSupport').classList.add('visible');
  document.getElementById('btnStart').disabled = true;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CÃœMLE LÄ°STESÄ°  â† buraya istediÄŸin kadar cÃ¼mle ekle
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CUMLELER = [
  "Ali",
  "IlÄ±k sÃ¼t",
  "Baba eve gel",
  "Annem bana elma aldÄ±",
  "Kedi sÃ¼tÃ¼nÃ¼ iÃ§ip uykuya daldÄ±",
  "Ali topu at",
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DURUM DEÄÄ°ÅKENLERÄ°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentSentenceIndex = 0;
let targetWords          = [];   // normalize edilmiÅŸ hedef kelimeler
let wordSpans            = [];   // DOM span referanslarÄ±
let currentWordIndex     = 0;
let score                = 0;
let isListening          = false;
let recognition          = null;
let restartDebounceTimer = null;
let lastError            = null;
let oyunBitti            = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM REFERANSLARI  (tek seferlik getElementById)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const btnStart       = document.getElementById('btnStart');
const btnStop        = document.getElementById('btnStop');
const wordCard       = document.getElementById('wordCard');
const scoreDisplay   = document.getElementById('scoreDisplay');
const micIndicator   = document.getElementById('micIndicator');
const micStatus      = document.getElementById('micStatus');
const interimText    = document.getElementById('interimText');
const congratsBanner = document.getElementById('congratsBanner');
const errorMsg       = document.getElementById('errorMsg');
const sentenceBadge  = document.getElementById('sentenceBadge');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEVENSHTEIN FUZZY MATCHING
   Kaynak: Wagner-Fischer algoritmasÄ±, O(n*m)
   EÅŸik: benzerlik >= ESIK_ORAN (0.0 â€“ 1.0)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ESIK_ORAN = 0.80; // %80 benzerlik yeterli

function levenshtein(a, b) {
  const m = a.length, n = b.length;
  // Performans: kÄ±sa devre
  if (m === 0) return n;
  if (n === 0) return m;
  if (a === b) return 0;

  // Tek satÄ±r buffer (bellek optimizasyonu)
  let prev = Array.from({ length: n + 1 }, (_, i) => i);
  let curr = new Array(n + 1);

  for (let i = 1; i <= m; i++) {
    curr[0] = i;
    for (let j = 1; j <= n; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      curr[j] = Math.min(
        curr[j - 1] + 1,       // ekleme
        prev[j] + 1,           // silme
        prev[j - 1] + cost     // deÄŸiÅŸtirme
      );
    }
    [prev, curr] = [curr, prev]; // swap (yeni dizi oluÅŸturmaz)
  }
  return prev[n];
}

/**
 * Ä°ki kelime arasÄ±ndaki benzerlik oranÄ±nÄ± dÃ¶ndÃ¼rÃ¼r (0.0 â€“ 1.0).
 */
function benzerlikOrani(a, b) {
  if (!a || !b) return 0;
  if (a === b) return 1;
  const maxLen = Math.max(a.length, b.length);
  if (maxLen === 0) return 1;
  return 1 - levenshtein(a, b) / maxLen;
}

/**
 * KonuÅŸulan kelime hedefle %80+ benzerlikte ise eÅŸleÅŸmiÅŸ sayÄ±lÄ±r.
 * Ek olarak prefix toleransÄ± da korunuyor (TÃ¼rkÃ§e ekleri iÃ§in).
 */
function kelimeEslesiyor(konusulan, hedef) {
  if (!konusulan || !hedef) return false;
  if (konusulan === hedef) return true;

  // Prefix toleransÄ± (TÃ¼rkÃ§e ek alma durumu)
  const minLen = Math.min(konusulan.length, hedef.length);
  if (minLen >= 3) {
    if (konusulan.startsWith(hedef)) return true;
    if (hedef.startsWith(konusulan)) return true;
  }

  // Fuzzy: Levenshtein benzerliÄŸi
  return benzerlikOrani(konusulan, hedef) >= ESIK_ORAN;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NORMALIZASYON  (TÃ¼rkÃ§e bÃ¼yÃ¼k-kÃ¼Ã§Ã¼k harf + noktalama)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function normalizeText(metin) {
  if (!metin || typeof metin !== 'string') return [];
  let s = metin
    .replace(/I/g, 'Ä±')
    .replace(/Ä°/g, 'i')
    .toLocaleLowerCase('tr-TR')
    .replace(/[^\p{L}\s]/gu, '');
  return s.split(/\s+/).filter(Boolean);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TTS: YANLIÅ KELÄ°MEYÄ° SESLENDÄ°R
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hedefiSeslendir(metin) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(metin);
  u.lang   = 'tr-TR';
  u.rate   = 0.85;
  u.pitch  = 1.0;
  u.volume = 1.0;

  // TÃ¼rkÃ§e ses seÃ§ (Chrome'da asenkron yÃ¼klenebilir)
  const voices  = window.speechSynthesis.getVoices();
  const trVoice = voices.find(v => v.lang === 'tr-TR' || v.lang.startsWith('tr'));
  if (trVoice) u.voice = trVoice;

  // TTS bitince mikrofonu yeniden baÅŸlat
  u.onend = () => {
    if (isListening && !oyunBitti && currentWordIndex < targetWords.length) {
      setTimeout(startRecognition, 250);
    }
  };

  // TTS baÅŸlarken aktif recognition'Ä± durdur (kendi sesini algÄ±lamasÄ±n)
  u.onstart = () => {
    if (recognition) {
      try { recognition.abort(); } catch(e) {}
      recognition = null;
    }
  };

  window.speechSynthesis.speak(u);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OYUNU KUR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function oyunuKur() {
  const idx    = currentSentenceIndex % CUMLELER.length;
  const cumle  = CUMLELER[idx];

  sentenceBadge.textContent = `CÃ¼mle ${idx + 1} / ${CUMLELER.length}`;

  const orijinal = cumle.split(/\s+/);
  targetWords    = normalizeText(cumle);
  wordSpans      = [];
  oyunBitti      = false;

  const frag = document.createDocumentFragment();
  targetWords.forEach((kelime, i) => {
    const span = document.createElement('span');
    span.className   = 'word' + (i === 0 ? ' active' : '');
    span.textContent = orijinal[i] || kelime;
    frag.appendChild(span);
    wordSpans.push(span);
  });

  wordCard.innerHTML = '';
  wordCard.appendChild(frag);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSCRIPT Ä°Ã‡Ä°NDE HEDEF ARA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function transcriptIsleBul(kelimeler) {
  if (currentWordIndex >= targetWords.length) return false;
  const hedef = targetWords[currentWordIndex];
  for (const k of kelimeler) {
    if (kelimeEslesiyor(k, hedef)) return true;
  }
  return false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KELÄ°ME DOÄRULAMA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function validateWord(dogru) {
  if (oyunBitti || currentWordIndex >= targetWords.length) return;

  const span = wordSpans[currentWordIndex];

  if (dogru) {
    span.className = 'word correct';
    score += 10;
    currentWordIndex++;

    const bitti = currentWordIndex === targetWords.length;
    requestAnimationFrame(updateUI);
    if (bitti) endGame();

  } else {
    const orijinalMetin = span.textContent;
    span.className = 'word wrong';

    // YanlÄ±ÅŸ â†’ doÄŸruyu seslendir
    hedefiSeslendir(orijinalMetin);

    setTimeout(() => {
      if (!oyunBitti && currentWordIndex < targetWords.length) {
        span.className = 'word active';
      }
    }, 900);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI GÃœNCELLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateUI() {
  if (currentWordIndex < wordSpans.length) {
    const span = wordSpans[currentWordIndex];
    if (!span.classList.contains('correct') && !span.classList.contains('wrong')) {
      span.className = 'word active';
    }
  }
  scoreDisplay.textContent = score;
  scoreDisplay.classList.remove('bump');
  void scoreDisplay.offsetWidth; // reflow â†’ animasyonu yeniden tetikle
  scoreDisplay.classList.add('bump');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OYUN SONU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function endGame() {
  if (oyunBitti) return;
  oyunBitti = true;

  stopRecognition();
  window.speechSynthesis && window.speechSynthesis.cancel();

  // TÃ¼m kelimeleri yeÅŸile Ã§evir
  wordSpans.forEach(s => { s.className = 'word correct'; });

  const idx        = currentSentenceIndex % CUMLELER.length;
  const sonrakiVar = idx + 1 < CUMLELER.length;

  congratsBanner.textContent = sonrakiVar
    ? 'ğŸ‰ Harika! Sonraki cÃ¼mleye geÃ§iliyor...'
    : 'ğŸ† TÃ¼m cÃ¼mleleri tamamladÄ±n!';
  congratsBanner.classList.add('visible');

  micStatus.classList.remove('listening');
  micStatus.textContent = 'ğŸ‰ Harika iÅŸ!';
  micIndicator.classList.remove('active');

  btnStart.disabled = true;
  btnStop.disabled  = true;

  setTimeout(() => {
    congratsBanner.classList.remove('visible');

    if (sonrakiVar) {
      currentSentenceIndex++;
      btnStop.disabled = false;
      oyunuSifirlaVeBaslat();
    } else {
      // TÃ¼m turlar bitti â€” sÄ±fÄ±rla, baÅŸlamayÄ± kullanÄ±cÄ±ya bÄ±rak
      currentSentenceIndex = 0;
      score = 0;
      scoreDisplay.textContent = '0';
      btnStart.disabled = false;
      btnStop.disabled  = true;
      micStatus.textContent = 'BaÅŸlamak iÃ§in dÃ¼ÄŸmeye bas';
      oyunuKur(); // ilk cÃ¼mleyi gÃ¶ster ama baÅŸlatma
    }
  }, 2000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TANIMI BAÅLAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startRecognition() {
  if (!SpeechRecognition || oyunBitti) return;

  // Ã–nceki instance'Ä± temizle
  if (recognition) {
    try { recognition.abort(); } catch(e) {}
    recognition = null;
  }

  errorMsg.classList.remove('visible');
  errorMsg.textContent = '';
  lastError = null;

  try {
    recognition = new SpeechRecognition();
    recognition.lang            = 'tr-TR';
    recognition.continuous      = false;  // her utterance ayrÄ± â†’ daha gÃ¼venilir
    recognition.interimResults  = false;  // sadece final â†’ gÃ¼rÃ¼ltÃ¼sÃ¼z, hÄ±zlÄ±
    recognition.maxAlternatives = 5;      // birden fazla alternatif â†’ fuzzy iÃ§in fayda

    recognition.onresult = handleSpeechResult;
    recognition.onerror  = handleSpeechError;
    recognition.onend    = handleRecognitionEnd;

    recognition.start();
    isListening = true;

    micIndicator.classList.add('active');
    micStatus.classList.add('listening');
    micStatus.textContent = 'ğŸ¤ Dinliyorum...';
  } catch (hata) {
    gosterHata('TanÄ±ma baÅŸlatÄ±lamadÄ±: ' + hata.message);
    isListening = false;
    btnStart.disabled = false;
    btnStop.disabled  = true;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TANIMI DURDUR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function stopRecognition() {
  isListening = false;

  if (restartDebounceTimer) {
    clearTimeout(restartDebounceTimer);
    restartDebounceTimer = null;
  }

  if (recognition) {
    try { recognition.abort(); } catch(e) {}
    recognition = null;
  }

  micIndicator.classList.remove('active');
  micStatus.classList.remove('listening');
  micStatus.textContent = 'BaÅŸlamak iÃ§in dÃ¼ÄŸmeye bas';
  interimText.textContent = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KONUÅMA SONUCU Ä°ÅLE
   interimResults = false olduÄŸu iÃ§in her event zaten final.
   Yine de gÃ¼venlik iÃ§in isFinal kontrolÃ¼ yapÄ±lÄ±yor.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleSpeechResult(event) {
  try {
    if (!event?.results || oyunBitti || currentWordIndex >= targetWords.length) return;

    // TÃ¼m final alternatifleri biriktir
    const tumKelimeler = [];

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const result = event.results[i];
      if (!result.isFinal) continue;

      for (let a = 0; a < result.length; a++) {
        const kelimeler = normalizeText(result[a].transcript);
        kelimeler.forEach(k => tumKelimeler.push(k));
      }
    }

    // GÃ¶sterim
    interimText.textContent = tumKelimeler.join(' ');

    if (tumKelimeler.length === 0) return;

    // EÅŸleÅŸme ara
    if (transcriptIsleBul(tumKelimeler)) {
      validateWord(true);
    } else {
      validateWord(false);
    }

  } catch(e) { /* sessiz */ }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HATA Ä°ÅLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleSpeechError(event) {
  try {
    lastError = event.error;
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      gosterHata('Mikrofon izni reddedildi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±ndan izin ver.');
      isListening = false;
      btnStart.disabled = false;
      btnStop.disabled  = true;
    } else if (event.error === 'network') {
      gosterHata('AÄŸ hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ± kontrol et.');
    }
    // no-speech â†’ onend restart halleder
  } catch(e) { /* sessiz */ }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TANIMI BÄ°TTÄ° â†’ YENÄ°DEN BAÅLAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleRecognitionEnd() {
  if (!isListening || oyunBitti) return;
  if (lastError === 'not-allowed' || lastError === 'service-not-allowed') return;

  if (restartDebounceTimer) clearTimeout(restartDebounceTimer);
  restartDebounceTimer = setTimeout(() => {
    if (isListening && !oyunBitti && currentWordIndex < targetWords.length) {
      startRecognition();
    }
  }, 120);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HATA MESAJI GÃ–STER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function gosterHata(mesaj) {
  errorMsg.textContent = mesaj;
  errorMsg.classList.add('visible');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OYUNU SIFIRLA VE BAÅLAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function oyunuSifirlaVeBaslat() {
  window.speechSynthesis && window.speechSynthesis.cancel();
  stopRecognition();

  currentWordIndex = 0;
  lastError        = null;
  oyunBitti        = false;

  interimText.textContent = '';
  congratsBanner.classList.remove('visible');
  errorMsg.classList.remove('visible');

  btnStart.disabled = true;
  btnStop.disabled  = false;

  oyunuKur();

  // KÄ±sa gecikme: Chrome abort â†’ start arasÄ± nefes
  setTimeout(startRecognition, 200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTON Ä°ÅLEYÄ°CÄ°LERÄ°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
btnStart.addEventListener('click', () => {
  if (!SpeechRecognition || isListening) return;

  // Autoplay engeli iÃ§in boÅŸ utterance
  window.speechSynthesis && window.speechSynthesis.speak(new SpeechSynthesisUtterance(''));

  currentSentenceIndex = 0;
  score = 0;
  scoreDisplay.textContent = '0';

  oyunuSifirlaVeBaslat();
});

btnStop.addEventListener('click', () => {
  if (!SpeechRecognition) return;
  window.speechSynthesis && window.speechSynthesis.cancel();
  micStatus.textContent = 'Yeniden baÅŸlatÄ±lÄ±yor...';
  oyunuSifirlaVeBaslat(); // aynÄ± cÃ¼mleyi tekrar oynat
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAYFA YÃœKLENDÄ°ÄÄ°NDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Chrome'da sesler asenkron yÃ¼klenir â€” getVoices() tetikle
if (window.speechSynthesis) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
}

oyunuKur();
</script>
</body>
</html>
