<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sesli Okuma Oyunu</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1b2d;
    --surface: #1a2d46;
    --surface2: #223558;
    --accent: #ffd166;
    --accent2: #06d6a0;
    --red: #ef476f;
    --green: #06d6a0;
    --yellow: #ffd166;
    --blue: #118ab2;
    --text: #e8f4fd;
    --text-muted: #7fa8c9;
    --radius: 20px;
    --shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Baloo 2', cursive;
    background: var(--bg);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }

  .stars {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
  }
  .star {
    position: absolute;
    border-radius: 50%;
    background: white;
    animation: twinkle var(--d, 3s) ease-in-out infinite;
    animation-delay: var(--delay, 0s);
    opacity: 0.3;
  }
  @keyframes twinkle {
    0%, 100% { opacity: 0.1; transform: scale(0.8); }
    50% { opacity: 0.7; transform: scale(1.2); }
  }

  .game-container {
    position: relative;
    z-index: 1;
    width: min(90vw, 640px);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 24px;
  }

  .title-area { text-align: center; }
  .title-area h1 {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(1.8rem, 6vw, 3rem);
    color: var(--accent);
    text-shadow: 0 0 20px rgba(255,209,102,0.4), 0 4px 8px rgba(0,0,0,0.5);
    letter-spacing: -0.5px;
  }
  .subtitle {
    font-size: 0.95rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .level-selector {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    margin-top: 10px;
  }
  .level-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    letter-spacing: 2px;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
  }
  .level-buttons {
    display: flex;
    gap: 10px;
  }
  .lvl-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: none;
    background: var(--lvl-color);
    color: #fff;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1rem;
    cursor: pointer;
    opacity: 0.35;
    transform: scale(0.85);
    transition: opacity 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
  }
  .lvl-btn.active {
    opacity: 1;
    transform: scale(1.15);
    box-shadow: 0 0 14px var(--lvl-color);
  }
  .lvl-btn:hover:not(.active) {
    opacity: 0.65;
    transform: scale(0.95);
  }

  .score-card {
    background: var(--surface);
    border: 2px solid var(--surface2);
    border-radius: var(--radius);
    padding: 12px 32px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: var(--shadow);
  }
  .score-icon { font-size: 1.6rem; }
  .score-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .score-value {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 2rem;
    color: var(--accent);
    line-height: 1;
    transition: transform 0.15s ease;
  }
  .score-value.bump { animation: scoreBump 0.3s ease; }
  @keyframes scoreBump {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); color: #fff; }
    100% { transform: scale(1); }
  }

  .word-card {
    background: var(--surface);
    border: 2px solid var(--surface2);
    border-radius: var(--radius);
    padding: 36px 40px;
    width: 100%;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    min-height: 120px;
    position: relative;
  }
  .word-card.celebrate {
    animation: cardCelebrate 0.6s ease forwards;
  }
  @keyframes cardCelebrate {
    0%   { box-shadow: var(--shadow); }
    30%  { box-shadow: 0 0 40px rgba(6,214,160,0.7), 0 0 80px rgba(6,214,160,0.3); }
    70%  { box-shadow: 0 0 25px rgba(255,209,102,0.6), 0 0 60px rgba(255,209,102,0.2); }
    100% { box-shadow: var(--shadow); }
  }

  .btn-skip {
    align-self: flex-end;
    background: transparent;
    border: 1px solid var(--surface2);
    border-radius: 8px;
    color: var(--text-muted);
    font-family: 'Baloo 2', cursive;
    font-size: 0.75rem;
    padding: 4px 10px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .btn-skip:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .word {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(2rem, 8vw, 3.5rem);
    padding: 8px 18px;
    border-radius: 14px;
    border: 3px solid transparent;
    transition: all 0.25s ease;
    cursor: default;
    letter-spacing: 0.5px;
    color: var(--text);
    background: transparent;
  }
  .word.active {
    background: rgba(255, 209, 102, 0.15);
    border-color: var(--yellow);
    color: var(--yellow);
    transform: scale(1.08);
    box-shadow: 0 0 20px rgba(255,209,102,0.3);
    animation: pulse 1.2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 20px rgba(255,209,102,0.3); }
    50% { box-shadow: 0 0 36px rgba(255,209,102,0.6); }
  }
  .word.correct {
    background: rgba(6, 214, 160, 0.15);
    border-color: var(--green);
    color: var(--green);
    animation: correctPop 0.4s ease forwards;
  }
  @keyframes correctPop {
    0% { transform: scale(1); }
    40% { transform: scale(1.15) rotate(-2deg); }
    70% { transform: scale(0.97) rotate(1deg); }
    100% { transform: scale(1) rotate(0deg); }
  }
  .word.wrong {
    background: rgba(239, 71, 111, 0.15);
    border-color: var(--red);
    color: var(--red);
    animation: shake 0.25s ease;
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(6px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
  }

  .mic-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  .mic-indicator {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--surface);
    border: 3px solid var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
    animation: breathe 3s ease-in-out infinite;
  }
  @keyframes breathe {
    0%, 100% { transform: scale(1);    box-shadow: var(--shadow); }
    50%       { transform: scale(1.07); box-shadow: 0 0 18px rgba(6,214,160,0.25); }
  }
  .mic-indicator.active {
    background: rgba(239, 71, 111, 0.15);
    border-color: var(--red);
    animation: micPulse 1s ease-in-out infinite;
  }
  /* TTS konuÅŸurken gÃ¶sterge */
  .mic-indicator.speaking {
    background: rgba(255, 209, 102, 0.15);
    border-color: var(--yellow);
    animation: speakPulse 0.8s ease-in-out infinite;
  }
  @keyframes micPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 71, 111, 0.4); }
    50% { box-shadow: 0 0 0 16px rgba(239, 71, 111, 0); }
  }
  @keyframes speakPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255, 209, 102, 0.4); }
    50% { box-shadow: 0 0 0 16px rgba(255, 209, 102, 0); }
  }
  .mic-status {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-align: center;
    min-height: 20px;
    transition: color 0.3s;
  }
  .mic-status.listening { color: var(--red); }
  .mic-status.speaking  { color: var(--yellow); }

  .interim-text {
    font-size: 0.9rem;
    color: var(--text-muted);
    font-style: italic;
    min-height: 22px;
    text-align: center;
    max-width: 400px;
    transition: opacity 0.2s;
    display: none;
  }

  .button-row { display: flex; gap: 16px; }
  .btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.1rem;
    padding: 14px 36px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 14px rgba(0,0,0,0.3);
    letter-spacing: 0.5px;
  }
  .btn:active { transform: scale(0.96); }
  .btn-start {
    background: linear-gradient(135deg, var(--green), #04b88a);
    color: #0a2a1f;
  }
  .btn-start:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(6,214,160,0.4);
  }
  .btn-stop {
    background: linear-gradient(135deg, var(--red), #d63060);
    color: #000;
  }
  .btn-stop:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239,71,111,0.4);
  }
  .btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none;
  }

  .congrats-banner {
    display: none;
    background: linear-gradient(135deg, #ffd166, #ff9f1c);
    color: #1a0a00;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(1.4rem, 5vw, 2rem);
    padding: 18px 40px;
    border-radius: var(--radius);
    text-align: center;
    width: 100%;
    box-shadow: 0 8px 32px rgba(255,209,102,0.5);
    animation: congratsIn 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
  }
  @keyframes congratsIn {
    0% { transform: scale(0.5) rotate(-4deg); opacity: 0; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
  }
  .congrats-banner.visible { display: block; }

  .error-msg {
    display: none;
    color: var(--red);
    font-size: 0.9rem;
    text-align: center;
    background: rgba(239,71,111,0.1);
    border: 1px solid rgba(239,71,111,0.3);
    border-radius: 12px;
    padding: 10px 20px;
    width: 100%;
  }
  .error-msg.visible { display: block; }


  /* â”€â”€â”€ Sekme ÅŸeridi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tab-strip {
    display: flex;
    gap: 0;
    background: var(--surface);
    border: 2px solid var(--surface2);
    border-radius: 50px;
    padding: 4px;
    margin-top: 10px;
  }
  .tab-btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.82rem;
    padding: 6px 18px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    background: transparent;
    color: var(--text-muted);
    transition: all 0.2s ease;
    letter-spacing: 0.3px;
  }
  .tab-btn.active {
    background: #a78bfa;
    color: #fff;
    box-shadow: 0 0 10px rgba(167,139,250,0.4);
  }
  .tab-btn:hover:not(.active) { color: var(--text); }


  /* â”€â”€â”€ Hikaye ilerleme Ã§ubuÄŸu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .story-progress {
    display: none;
    width: 100%;
    background: var(--surface);
    border: 2px solid var(--surface2);
    border-radius: var(--radius);
    padding: 12px 16px;
    box-shadow: var(--shadow);
  }
  .story-progress.visible { display: block; }
  .story-progress-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 8px;
  }
  .story-progress-title {
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    color: #a78bfa;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .story-nav-btn {
    background: var(--surface2);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    color: #a78bfa;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
    line-height: 1;
  }
  .story-nav-btn:hover {
    background: #a78bfa;
    color: #fff;
    transform: scale(1.1);
    box-shadow: 0 0 10px rgba(167,139,250,0.4);
  }
  .story-nav-btn:active { transform: scale(0.95); }
  .story-progress-bar-wrap {
    background: var(--surface2);
    border-radius: 8px;
    height: 7px;
    overflow: hidden;
  }
  .story-progress-bar {
    height: 100%;
    border-radius: 8px;
    background: linear-gradient(90deg, #a78bfa, #7c3aed);
    transition: width 0.4s ease;
    width: 0%;
  }
  .story-progress-text {
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-top: 5px;
    text-align: right;
  }

  /* â”€â”€â”€ Rapor overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .report-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(10, 18, 30, 0.88);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .report-overlay.visible {
    display: flex;
    animation: reportFadeIn 0.35s ease;
  }
  @keyframes reportFadeIn {
    from { opacity: 0; transform: scale(0.92); }
    to   { opacity: 1; transform: scale(1); }
  }
  .report-card {
    background: var(--surface);
    border: 2px solid var(--surface2);
    border-radius: 28px;
    padding: 32px 36px;
    width: min(92vw, 440px);
    box-shadow: 0 16px 48px rgba(0,0,0,0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px;
    text-align: center;
  }
  .report-emoji { font-size: 3rem; }
  .report-title {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.5rem;
    color: var(--accent);
  }
  .report-subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: -10px;
  }
  .report-stats {
    display: flex;
    gap: 16px;
    justify-content: center;
    flex-wrap: wrap;
    width: 100%;
  }
  .report-stat {
    background: var(--surface2);
    border-radius: 16px;
    padding: 12px 20px;
    min-width: 90px;
    flex: 1;
  }
  .report-stat-val {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.8rem;
    line-height: 1;
  }
  .report-stat-val.green  { color: var(--green); }
  .report-stat-val.red    { color: var(--red); }
  .report-stat-val.yellow { color: var(--yellow); }
  .report-stat-lbl {
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .report-hard-words {
    background: var(--surface2);
    border-radius: 14px;
    padding: 10px 16px;
    width: 100%;
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.6;
  }
  .report-hard-words strong { color: var(--red); font-weight: 700; }
  .hw-title {
    font-size: 0.72rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-muted);
    display: block;
    margin-bottom: 4px;
  }
  .report-btn-row {
    display: flex;
    gap: 12px;
    width: 100%;
  }
  .report-btn {
    flex: 1;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1rem;
    padding: 12px 10px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .report-btn:active { transform: scale(0.96); }
  .report-btn.primary {
    background: linear-gradient(135deg, var(--green), #04b88a);
    color: #0a2a1f;
    box-shadow: 0 4px 14px rgba(6,214,160,0.3);
  }
  .report-btn.secondary {
    background: var(--surface2);
    color: var(--text-muted);
  }
  .report-timer-bar-wrap {
    width: 100%;
    height: 4px;
    background: var(--surface2);
    border-radius: 4px;
    overflow: hidden;
  }
  .report-timer-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 4px;
    transition: width linear;
  }

  .no-support {
    display: none;
    color: var(--accent);
    text-align: center;
    font-size: 1.1rem;
    padding: 20px;
  }
  .no-support.visible { display: block; }
</style>
</head>
<body>

<div class="stars" id="stars"></div>

<div class="game-container" id="gameContainer">

  <div class="title-area">
    <h1>ğŸŒŸ Sesli Okuma Oyunu</h1>
    <p class="subtitle">Kelimeyi sesli oku ve puan kazan!</p>
    <div class="level-selector">
      <span class="level-label">SEVÄ°YE</span>
      <div class="level-buttons">
        <button class="lvl-btn active" data-level="0" style="--lvl-color:#ef476f">1</button>
        <button class="lvl-btn" data-level="1" style="--lvl-color:#f4a261">2</button>
        <button class="lvl-btn" data-level="2" style="--lvl-color:#ffd166">3</button>
        <button class="lvl-btn" data-level="3" style="--lvl-color:#06d6a0">4</button>
        <button class="lvl-btn" data-level="4" style="--lvl-color:#118ab2">5</button>
      </div>
    </div>
    <div class="tab-strip">
      <button class="tab-btn active" id="tabAlistirma">ğŸ“ AlÄ±ÅŸtÄ±rma</button>
      <button class="tab-btn" id="tabHikaye">ğŸ“– Hikaye</button>
    </div>
  </div>

  <div class="story-progress" id="storyProgress">
    <div class="story-progress-header">
      <button class="story-nav-btn" id="btnHikayeGeri">&#9664;</button>
      <div class="story-progress-title" id="storyTitle">ğŸ“– Hikaye</div>
      <button class="story-nav-btn" id="btnHikayeIleri">&#9654;</button>
    </div>
    <div class="story-progress-bar-wrap">
      <div class="story-progress-bar" id="storyBar"></div>
    </div>
    <div class="story-progress-text" id="storyProgressText">1 / 16</div>
  </div>

  <div class="score-card">
    <span class="score-icon">â­</span>
    <div>
      <div class="score-label">Puan</div>
      <div class="score-value" id="scoreDisplay">0</div>
    </div>
  </div>

  <div class="word-card" id="wordCard"></div>
  <button class="btn-skip" id="btnSkip">GeÃ§</button>

  <div class="mic-area">
    <div class="mic-indicator" id="micIndicator">ğŸ¤</div>
    <div class="mic-status" id="micStatus">BaÅŸlamak iÃ§in dÃ¼ÄŸmeye bas</div>
  </div>

  <div class="interim-text" id="interimText"></div>

  <div class="button-row">
    <button class="btn btn-start" id="btnStart">â–¶ BaÅŸla</button>
    <button class="btn btn-stop" id="btnStop" disabled>ğŸ”„ Tekrar</button>
  </div>

  <div class="congrats-banner" id="congratsBanner">
    ğŸ‰ Tebrikler! Harika okudun! ğŸ‰
  </div>

  <div class="error-msg" id="errorMsg"></div>

  <div class="no-support" id="noSupport">
    ğŸ˜” ÃœzgÃ¼nÃ¼m, tarayÄ±cÄ±n sesli tanÄ±ma Ã¶zelliÄŸini desteklemiyor. LÃ¼tfen Google Chrome kullan.
  </div>

</div>

<!-- â”€â”€â”€ Rapor Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="report-overlay" id="reportOverlay">
  <div class="report-card">
    <div class="report-emoji" id="reportEmoji">ğŸŒŸ</div>
    <div class="report-title" id="reportTitle">BÃ¶lÃ¼m TamamlandÄ±!</div>
    <div class="report-subtitle" id="reportSubtitle"></div>
    <div class="report-stats">
      <div class="report-stat">
        <div class="report-stat-val green" id="reportDogru">0</div>
        <div class="report-stat-lbl">DoÄŸru</div>
      </div>
      <div class="report-stat">
        <div class="report-stat-val red" id="reportYanlis">0</div>
        <div class="report-stat-lbl">YanlÄ±ÅŸ</div>
      </div>
      <div class="report-stat">
        <div class="report-stat-val yellow" id="reportPuan">0</div>
        <div class="report-stat-lbl">Puan</div>
      </div>
    </div>
    <div class="report-hard-words" id="reportHardWords" style="display:none">
      <span class="hw-title">En Ã§ok takÄ±lan kelimeler</span>
      <span id="reportHardList"></span>
    </div>
    <div class="report-timer-bar-wrap" id="reportTimerWrap" style="display:none">
      <div class="report-timer-bar" id="reportTimerBar" style="width:100%"></div>
    </div>
    <div class="report-btn-row" id="reportBtnRow">
      <button class="report-btn primary" id="reportBtnNext">â–¶ Devam</button>
    </div>
  </div>
</div>

<script>
"use strict";

// â”€â”€â”€ YÄ±ldÄ±z arka planÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function yaratYildizlar() {
  const starsEl  = document.getElementById('stars');
  const fragment = document.createDocumentFragment();
  for (let i = 0; i < 80; i++) {
    const s    = document.createElement('div');
    s.className = 'star';
    const boyut = Math.random() * 3 + 1;
    s.style.cssText = `width:${boyut}px;height:${boyut}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${2+Math.random()*4}s;--delay:${Math.random()*5}s;`;
    fragment.appendChild(s);
  }
  starsEl.appendChild(fragment);
})();

// â”€â”€â”€ TarayÄ±cÄ± desteÄŸi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

// â”€â”€â”€ DOM referanslarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const btnStart       = document.getElementById('btnStart');
const btnStop        = document.getElementById('btnStop');
const btnSkip        = document.getElementById('btnSkip');
const wordCard       = document.getElementById('wordCard');
const scoreDisplay   = document.getElementById('scoreDisplay');
const micIndicator   = document.getElementById('micIndicator');
const micStatus      = document.getElementById('micStatus');
const interimText    = document.getElementById('interimText');
const congratsBanner = document.getElementById('congratsBanner');
const errorMsg       = document.getElementById('errorMsg');
const noSupport         = document.getElementById('noSupport');
const tabAlistirma      = document.getElementById('tabAlistirma');
const tabHikaye         = document.getElementById('tabHikaye');
const storyProgress     = document.getElementById('storyProgress');
const storyTitle        = document.getElementById('storyTitle');
const storyBar          = document.getElementById('storyBar');
const storyProgressText = document.getElementById('storyProgressText');
const btnHikayeGeri     = document.getElementById('btnHikayeGeri');
const btnHikayeIleri    = document.getElementById('btnHikayeIleri');
const reportOverlay     = document.getElementById('reportOverlay');
const reportEmoji       = document.getElementById('reportEmoji');
const reportTitle       = document.getElementById('reportTitle');
const reportSubtitle    = document.getElementById('reportSubtitle');
const reportDogru       = document.getElementById('reportDogru');
const reportYanlis      = document.getElementById('reportYanlis');
const reportPuan        = document.getElementById('reportPuan');
const reportHardWords   = document.getElementById('reportHardWords');
const reportHardList    = document.getElementById('reportHardList');
const reportTimerWrap   = document.getElementById('reportTimerWrap');
const reportTimerBar    = document.getElementById('reportTimerBar');
const reportBtnRow      = document.getElementById('reportBtnRow');
const reportBtnNext     = document.getElementById('reportBtnNext');

if (!SpeechRecognition) {
  noSupport.classList.add('visible');
  btnStart.disabled = true;
}

// â”€â”€â”€ CÃ¼mle listesi (MEB Harf GruplarÄ±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Grup 1: E L A K Ä° N
// Grup 2: + O M U T Ãœ Y
// Grup 3: + Ã– R I(=Ä±) D S B
// Grup 4: + Z Ã‡ G Å C P
// Grup 5: + H V Ä F J
// Her cÃ¼mle doÄŸrulanmÄ±ÅŸtÄ±r: yalnÄ±zca ilgili ve Ã¶nceki gruplarÄ±n harflerini iÃ§erir.

const CUMLE_GRUPLARI = [
  // â”€â”€ Grup 1: E L A K Ä° N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [
    "Ali kal",
    "Lale al",
    "Ä°nek kal",
    "Ekin al",
    "Kale al",
    "Ali kale",
    "Ä°nek al",
    "Kel kal",
    "Lale kal",
    "Ali ile kal",
    "Ä°nek kale",
    "Ekin ile al",
    "Kale kal",
    "Ali inek",
    "Lale ile kal",
  ],
  // â”€â”€ Grup 2: + O M U T Ãœ Y â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [
    "Mete kal",
    "ÃœtÃ¼ al",
    "Yol kal",
    "Okul al",
    "Mutlu ol",
    "Mete yolu al",
    "TÃ¼m yol kal",
    "Yolun otu",
    "Mutlu lale",
    "Okulun yolu",
    "ÃœtÃ¼yÃ¼ al",
    "ÃœtÃ¼ koy",
    "Mete okul",
    "TÃ¼m okul",
    "Yolu taklit et",
  ],
  // â”€â”€ Grup 3: + Ã– R I(Ä±) D S B â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [
    "ArÄ± bal al",
    "BalÄ±k al",
    "BÄ±rak onu",
    "Dere kal",
    "Resim kal",
    "SÃ¶yle bana",
    "Dondurma al",
    "Araba sÃ¼r",
    "Bal kadar",
    "SÄ±ra kal",
    "BÄ±rak al",
    "Dere balÄ±k",
    "ArÄ± uyu",
    "Ã–rdek al",
    "BÃ¼yÃ¼k Ã¶rdek",
  ],
  // â”€â”€ Grup 4: + Z Ã‡ G Å C P â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [
    "Ã‡iÃ§ek al",
    "GÃ¼l bak",
    "Åeker al",
    "Ã‡anta bul",
    "Pazara git",
    "GÃ¶zlÃ¼k al",
    "Ã‡ocuk gel",
    "Åeker Ã§ok",
    "Ã‡ilek al",
    "Pazarda bul",
    "GÃ¶zleri sil",
    "Ã‡anta doldur",
    "Åeker bul",
    "Ã‡iÃ§ek bak",
    "Pazarda kal",
  ],
  // â”€â”€ Grup 5: + H V Ä F J â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [
    "Hava gÃ¼zel",
    "Filmi gÃ¶r",
    "VahÅŸi hayvan",
    "Hafif gel",
    "Varmak iÃ§in git",
    "Filmi ver",
    "Havaya bak",
    "AÄŸaÃ§ var",
    "Hava Ã§ok gÃ¼zel",
    "Filmi bitir",
    "FÄ±rÄ±n al",
    "Havuz var",
    "FÄ±ndÄ±k al",
    "HÄ±zla gel",
    "YavaÅŸ git",
  ],
];

// â”€â”€â”€ Hikaye Verileri â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HIKAYE_GRUPLARI = [
  // Hikaye 1: Henna ve Kediler
  [
    "Henna sabah uyandÄ±.",
    "OdasÄ±nda iki kÃ¼Ã§Ã¼k kedi vardÄ±.",
    "Kediler mÄ±rladÄ±.",
    "Henna onlara sÃ¼t verdi.",
    "Kediler sÃ¼t iÃ§ti.",
    "Henna onlarÄ± severdi.",
    "Sonra birlikte bahÃ§eye Ã§Ä±ktÄ±lar.",
    "Kediler Ã§imenlerde koÅŸturdu.",
    "Kediler kelebekleri kovaladÄ±.",
    "Henna kedileri izledi ve gÃ¼lÃ¼msedi.",
    "GÃ¼n Ã§ok gÃ¼zeldi.",
    "Henna kedileri sepetten Ã§Ä±kardÄ±.",
    "Kediler top oynadÄ±.",
    "Henna onlarÄ± izledi.",
    "Kediler yoruldu.",
    "Henna onlarÄ± uyuttu."
  ],
  // Hikaye 2: Mustafa ve AyakkabÄ±sÄ±
  [
    "Mustafa yeni ayakkabÄ±sÄ±nÄ± giymiÅŸti.",
    "Mustafa Ã§ok mutlu oldu.",
    "Hemen Ã§imlere Ã§Ä±ktÄ±.",
    "Top oynamaya baÅŸladÄ±.",
    "Topu arkadaÅŸÄ±na pasladÄ±.",
    "Birlikte gÃ¼ldÃ¼ler.",
    "Mustafa koÅŸarken ayakkabÄ±sÄ± parlÄ±yordu.",
    "Oyun Ã§ok eÄŸlenceliydi.",
    "Oyun bittiÄŸinde topunu topladÄ±.",
    "Eve dÃ¶nmeye hazÄ±rlandÄ±."
  ]
];

const HIKAYE_ISIMLERI = ['Henna ve Kediler', 'Mustafa ve AyakkabÄ±sÄ±'];

// â”€â”€â”€ localStorage yardÄ±mcÄ±larÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LS_KEY = 'sesliOkumaOyunu_v1';
function kaydet() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify({
      grupIndex, cumleIndex, hikayeModu, hikayeIndex, hikayeCumle, totalScore
    }));
  } catch(e) {}
}
function yukle() {
  try {
    const d = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
    if (!d) return;
    grupIndex   = d.grupIndex   || 0;
    cumleIndex  = d.cumleIndex  || 0;
    hikayeModu  = d.hikayeModu  || false;
    hikayeIndex = d.hikayeIndex || 0;
    hikayeCumle = d.hikayeCumle || 0;
    totalScore  = d.totalScore  || 0;
  } catch(e) {}
}

// Gruplar sÄ±rayla ilerler; her grup bitince sonraki baÅŸlar
let grupIndex  = 0;
let cumleIndex = 0;

// â”€â”€â”€ Hikaye Modu Durumu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let hikayeModu    = false;
let hikayeIndex   = 0;
let hikayeCumle   = 0;

// â”€â”€â”€ BÃ¶lÃ¼m istatistikleri (rapor iÃ§in) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let bolumDogru    = 0;
let bolumYanlis   = 0;
let kelimeHatalar = {};  // { kelime: hataAdedi }

const CUMLELER = CUMLE_GRUPLARI[grupIndex];
const HEDEF_METIN = () => {
  if (hikayeModu) {
    const hikaye = HIKAYE_GRUPLARI[hikayeIndex];
    return hikaye[hikayeCumle % hikaye.length];
  }
  const grup = CUMLE_GRUPLARI[grupIndex];
  return grup[cumleIndex % grup.length];
};

// â”€â”€â”€ Oyun durumu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let targetWords        = [];
let wordSpans          = [];
let currentWordIndex   = 0;
let score              = 0;
let totalScore         = 0;   // oyun boyunca toplam puan
let processedWordCount = 0;
let yanlisSayac        = 0;   // yanlÄ±ÅŸ telaffuz sayacÄ± (TTS tetikleme iÃ§in)
let endGameTimer       = null; // race condition korumasÄ±

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SpeechController
// Tek sorumluluk: TTS ve Recognition lifecycle'Ä±nÄ± Ã§akÄ±ÅŸmasÄ±z yÃ¶netmek.
//
// KURAL: TTS aktifken Recognition kapalÄ±.
//        Recognition aktifken TTS baÅŸlatÄ±lamaz.
//        TTS yalnÄ±zca yanlÄ±ÅŸ telaffuzda dÄ±ÅŸarÄ±dan tetiklenir.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SpeechController = (function () {

  // â”€â”€ Ä°Ã§ durum â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let recognition   = null;
  let recState      = 'idle';   // 'idle' | 'starting' | 'listening' | 'stopping'
  let isSpeaking    = false;
  let lastError     = null;
  let silenceTimer  = null;
  let restartTimer  = null;
  let watchdogTimer = null;   // recognition sessizce dÃ¼ÅŸtÃ¼yse yakalar
  let trVoiceCache  = null;

  // â”€â”€ TÃ¼rkÃ§e ses seÃ§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getTrVoice() {
    if (trVoiceCache) return trVoiceCache;
    const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
    trVoiceCache = voices.find(v => v.lang === 'tr-TR' && v.localService)
                || voices.find(v => v.lang === 'tr-TR')
                || null;
    return trVoiceCache;
  }
  if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = () => { trVoiceCache = null; getTrVoice(); };
  }

  // â”€â”€ Timer yardÄ±mcÄ±larÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clearTimers() {
    if (silenceTimer)  { clearTimeout(silenceTimer);  silenceTimer  = null; }
    if (restartTimer)  { clearTimeout(restartTimer);  restartTimer  = null; }
    if (watchdogTimer) { clearTimeout(watchdogTimer); watchdogTimer = null; }
  }

  // Watchdog: recognition sessizce dÃ¼ÅŸtÃ¼yse 3sn iÃ§inde yakalar ve restart yapar
  function resetWatchdog() {
    if (watchdogTimer) clearTimeout(watchdogTimer);
    watchdogTimer = setTimeout(() => {
      watchdogTimer = null;
      if (isSpeaking) return;
      if (currentWordIndex >= targetWords.length) return;
      if (recState !== 'listening') {
        // Recognition ayakta deÄŸil, yeniden baÅŸlat
        scheduleRestart(100);
      } else {
        // Ayakta gÃ¶rÃ¼nÃ¼yor ama emin olmak iÃ§in watchdog'u yenile
        resetWatchdog();
      }
    }, 3000);
  }

  function scheduleRestart(ms) {
    if (restartTimer) clearTimeout(restartTimer);
    restartTimer = setTimeout(() => {
      restartTimer = null;
      if (!isSpeaking && recState === 'idle') _start();
    }, ms || 300);
  }

  function resetSilenceTimer() {
    if (silenceTimer) clearTimeout(silenceTimer);
    if (recState !== 'listening') return;
    silenceTimer = setTimeout(() => {
      if (recState === 'listening' && !isSpeaking && currentWordIndex < targetWords.length) {
        _stop(true); // sessizlik â†’ restart
      }
    }, 3500);
  }

  // â”€â”€ Recognition iÃ§ inÅŸa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function _build() {
    if (!SpeechRecognition) return;
    if (recognition) {
      recognition.onresult = null;
      recognition.onerror  = null;
      recognition.onend    = null;
      try { recognition.abort(); } catch (e) {}
      recognition = null;
    }
    recognition = new SpeechRecognition();
    recognition.lang            = 'tr-TR';
    recognition.continuous      = true;
    recognition.interimResults  = true;
    recognition.maxAlternatives = 5;
    recognition.onstart  = _onStart;
    recognition.onresult = _onResult;
    recognition.onerror  = _onError;
    recognition.onend    = _onEnd;
  }

  // â”€â”€ Recognition event handler'larÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function _onStart() {
    // Recognition gerÃ§ekten baÅŸladÄ± â€” state'i gÃ¼venle otur
    recState = 'listening';
    resetWatchdog();
    micIndicator.className = 'mic-indicator active';
    micStatus.className    = 'mic-status listening';
    micStatus.textContent  = 'ğŸ¤ Dinliyorum...';
  }
  function _onResult(event) {
    if (!event || !event.results) return;
    if (isSpeaking) return;   // TTS aktifken echo korumasÄ±

    resetWatchdog();   // ses geldi â†’ recognition ayakta, watchdog'u yenile
    interimText.textContent = event.results[event.results.length - 1][0].transcript;
    resetSilenceTimer();

    // â”€â”€ Interim: sadece tam eÅŸleÅŸme kabul et â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) continue;           // final'ler aÅŸaÄŸÄ±da iÅŸlenir
      if (currentWordIndex >= targetWords.length) break;
      const hedef   = targetWords[currentWordIndex];
      const tokenler = normalizeText(event.results[i][0].transcript);
      for (let t = 0; t < tokenler.length; t++) {
        if (currentWordIndex >= targetWords.length) break;
        if (tokenler[t] === targetWords[currentWordIndex]) {
          validateWord(tokenler[t]);
        }
      }
    }

    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (!event.results[i].isFinal) continue;
      const sonuc = event.results[i];

      // Alternatifleri confidence'a gÃ¶re azalan sÄ±raya diz
      const altDizisi = [];
      for (let a = 0; a < sonuc.length; a++) {
        altDizisi.push({ transcript: sonuc[a].transcript, confidence: sonuc[a].confidence || 0 });
      }
      altDizisi.sort((x, y) => y.confidence - x.confidence);

      // Her alternatifin tokenlerini hazÄ±rla (confidence sÄ±rasÄ±nda)
      const altTokenler = altDizisi.map(alt => normalizeText(alt.transcript));

      // Ana transcript token sayÄ±sÄ±nÄ± baz al (en yÃ¼ksek confidence)
      const anaTokenler = altTokenler[0] || [];
      for (let t = 0; t < anaTokenler.length; t++) {
        if (currentWordIndex >= targetWords.length) break;
        const hedef = targetWords[currentWordIndex];
        // Bu pozisyon iÃ§in tÃ¼m alternatiflerde eÅŸleÅŸen var mÄ±?
        let bulunan = null;
        for (let a = 0; a < altTokenler.length; a++) {
          const tok = altTokenler[a][t];
          if (tok && kelimeEslesir(tok, hedef)) { bulunan = tok; break; }
        }
        // Pozisyon eÅŸleÅŸmedi â€” tÃ¼m alternatiflerde herhangi bir pozisyonda ara
        if (!bulunan) {
          for (let a = 0; a < altTokenler.length; a++) {
            for (let p = 0; p < altTokenler[a].length; p++) {
              const tok = altTokenler[a][p];
              if (tok && kelimeEslesir(tok, hedef)) { bulunan = tok; break; }
            }
            if (bulunan) break;
          }
        }
        // EÅŸleÅŸme yoksa ana token'Ä± kullan (yanlÄ±ÅŸ olarak iÅŸlenir)
        validateWord(bulunan || anaTokenler[t]);
      }
    }
  }

  function _onError(event) {
    lastError = event.error;
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      gosterHata('Mikrofon izni reddedildi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±ndan izin ver.');
      recState = 'idle';
      btnStart.disabled = false;
      btnStop.disabled  = true;
    } else if (event.error === 'network') {
      gosterHata('AÄŸ hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ± kontrol et.');
    }
    // 'no-speech', 'aborted' â†’ _onEnd yÃ¶netir
  }

  function _onEnd() {
    recState = 'idle';
    if (lastError === 'not-allowed' || lastError === 'service-not-allowed') return;
    if (currentWordIndex >= targetWords.length) return;
    // TTS aktifse restart yapma â€” speakCorrection.ut.onend iÃ§inde yapacak
    if (isSpeaking) return;
    scheduleRestart(300);
  }

  // â”€â”€ Ä°Ã§ start/stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function _start() {
    if (!SpeechRecognition) return;
    if (recState === 'starting' || recState === 'listening') return;
    if (isSpeaking) return;
    if (lastError === 'not-allowed' || lastError === 'service-not-allowed') return;

    errorMsg.classList.remove('visible');
    lastError = null;
    _build();
    recState = 'starting';

    try {
      recognition.start();
      recState = 'starting';
      // micIndicator ve micStatus â†’ _onStart'ta gÃ¼ncellenir
      interimText.textContent = '';
    } catch (e) {
      recState = 'idle';
      if (e.name === 'InvalidStateError') {
        scheduleRestart(500);
      } else {
        gosterHata('Mikrofon baÅŸlatÄ±lamadÄ±: ' + e.message);
      }
    }
  }

  function _stop(andRestart) {
    clearTimers();
    if (recState === 'idle') return;
    recState = 'stopping';
    if (recognition) { try { recognition.stop(); } catch (e) {} }
    micIndicator.className = 'mic-indicator';
    micStatus.className    = 'mic-status';
    micStatus.textContent  = 'BaÅŸlamak iÃ§in dÃ¼ÄŸmeye bas';
    interimText.textContent = '';
    // _onEnd â†’ recState = 'idle' â†’ scheduleRestart varsa Ã§alÄ±ÅŸÄ±r
    if (andRestart) {
      // _onEnd iÃ§inde zaten scheduleRestart Ã§aÄŸrÄ±lacak
    }
  }

  // â”€â”€ Public API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return {

    /**
     * BaÅŸlat â€” oyun baÅŸlangÄ±cÄ± veya Tekrar butonunda Ã§aÄŸrÄ±lÄ±r.
     */
    startListening() {
      lastError = null;
      resetWatchdog();
      scheduleRestart(100);
    },

    /**
     * TTS ile yanlÄ±ÅŸ kelimeyi sÃ¶yle.
     * Ã‡aÄŸrÄ±lmadan Ã¶nce Recognition otomatik durdurulur.
     * TTS bitince Recognition otomatik yeniden baÅŸlar.
     * SADECE yanlÄ±ÅŸ telaffuzda dÄ±ÅŸarÄ±dan Ã§aÄŸrÄ±lmalÄ±.
     */
    speakCorrection(metin, opts) {
      if (!window.speechSynthesis) return;
      opts = opts || {};
      const rate  = opts.rate  || 0.80;
      const pitch = opts.pitch || 1.05;

      // TTS baÅŸlamadan Ã¶nce isSpeaking = true â€” _onEnd'in restart yapmasÄ±nÄ± engeller
      isSpeaking = true;
      window.speechSynthesis.cancel();
      clearTimers();

      // Recognition'Ä± sessizce iptal et (abort â†’ _onEnd tetiklenir ama isSpeaking=true olduÄŸu iÃ§in restart yapmaz)
      if (recognition && recState !== 'idle') {
        recState = 'stopping';
        try { recognition.abort(); } catch (e) {}
      }

      micIndicator.className = 'mic-indicator speaking';
      micStatus.className    = 'mic-status speaking';
      micStatus.textContent  = 'ğŸ”Š Dinle...';
      interimText.textContent = '';

      const ut    = new SpeechSynthesisUtterance(metin);
      ut.lang     = 'tr-TR';
      ut.rate     = rate;
      ut.pitch    = pitch;
      ut.volume   = 1;
      const voice = getTrVoice();
      if (voice) ut.voice = voice;

      ut.onend = () => {
        isSpeaking = false;
        micIndicator.className = 'mic-indicator';
        micStatus.className    = 'mic-status';
        micStatus.textContent  = '';
        if (currentWordIndex < targetWords.length) {
          resetWatchdog();
          scheduleRestart(250);
        }
      };

      ut.onerror = () => {
        isSpeaking = false;
        micIndicator.className = 'mic-indicator';
        micStatus.className    = 'mic-status';
        if (currentWordIndex < targetWords.length) {
          resetWatchdog();
          scheduleRestart(300);
        }
      };

      // KÄ±sa gecikme: abort'un onEnd'i tetiklemesi iÃ§in zaman tanÄ±
      setTimeout(() => { window.speechSynthesis.speak(ut); }, 150);
    },

    /**
     * Her ÅŸeyi durdur â€” sÄ±fÄ±rlama veya oyun sonu.
     */
    stopAll() {
      isSpeaking = false;
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      clearTimers();
      if (recState !== 'idle') {
        recState = 'stopping';
        if (recognition) { try { recognition.stop(); } catch (e) {} }
      }
      micIndicator.className = 'mic-indicator';
      micStatus.className    = 'mic-status';
      micStatus.textContent  = 'BaÅŸlamak iÃ§in dÃ¼ÄŸmeye bas';
      interimText.textContent = '';
    },

    isSpeaking() { return isSpeaking; },
    isListening() { return recState === 'listening'; }
  };
})();

// â”€â”€â”€ TÃ¼rkÃ§e normalizasyon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeText(metin) {
  if (!metin || typeof metin !== 'string') return [];
  let sonuc = metin.replace(/I/g, 'Ä±').replace(/Ä°/g, 'i').toLocaleLowerCase('tr-TR');
  sonuc = sonuc.replace(/[^\p{L}\s]/gu, '');
  return sonuc.split(/\s+/).filter(t => t.length > 0);
}

// â”€â”€â”€ Levenshtein mesafesi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function levenshtein(a, b) {
  const m = a.length, n = b.length;
  if (m === 0) return n;
  if (n === 0) return m;
  const dp = [];
  for (let i = 0; i <= m; i++) dp[i] = [i];
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      dp[i][j] = a[i-1] === b[j-1]
        ? dp[i-1][j-1]
        : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
    }
  }
  return dp[m][n];
}

// â”€â”€â”€ ToleranslÄ± eÅŸleÅŸme (katmanlÄ±, mod farkÄ±ndalÄ±klÄ±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function kelimeEslesir(konusulan, hedef) {
  if (konusulan === hedef) return true;
  const dist     = levenshtein(konusulan, hedef);
  const maxLen   = Math.max(hedef.length, konusulan.length);
  const dogruluk = (1 - dist / maxLen) * 100;

  if (hikayeModu) {
    // â”€â”€ Hikaye modu: daha sÄ±kÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let esik;
    if (hedef.length <= 5)      esik = 75;
    else if (hedef.length <= 8) esik = 80;
    else                        esik = 85;
    return dogruluk >= esik;
  }

  // â”€â”€ Normal mod: R/L geliÅŸmekte olan dil iÃ§in toleranslÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let tolerans;
  if (hedef.length <= 3)      tolerans = 1;
  else if (hedef.length <= 5) tolerans = 2;
  else if (hedef.length <= 8) tolerans = 3;
  else                        tolerans = 4;

  let minDogruluk;
  if (hedef.length <= 4)      minDogruluk = 55;
  else if (hedef.length <= 6) minDogruluk = 62;
  else                        minDogruluk = 68;

  if (dogruluk < minDogruluk) return false;
  return dist <= Math.min(tolerans, Math.floor(maxLen * 0.45));
}

// â”€â”€â”€ TÃ¼m alternatifleri kontrol et â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkAlternatives(result) {
  for (let a = 0; a < result.length; a++) {
    const tokenler = normalizeText(result[a].transcript);
    if (tokenler.length === 0) continue;
    if (kelimeEslesir(tokenler[0], targetWords[currentWordIndex])) return tokenler[0];
  }
  return normalizeText(result[0].transcript)[0] || '';
}

// â”€â”€â”€ UI gÃ¼ncelle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUI() {
  wordSpans.forEach((span, i) => {
    if (i === currentWordIndex && !span.classList.contains('correct') && !span.classList.contains('wrong')) {
      span.className = 'word active';
    }
  });

  const eskiPuan = parseInt(scoreDisplay.textContent, 10);
  scoreDisplay.textContent = totalScore;
  if (totalScore !== eskiPuan) {
    scoreDisplay.classList.remove('bump');
    void scoreDisplay.offsetWidth;
    scoreDisplay.classList.add('bump');
  }
}

// â”€â”€â”€ Oyunu kur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function oyunuKur() {
  const metin = HEDEF_METIN();
  targetWords = normalizeText(metin);
  const fragment = document.createDocumentFragment();
  wordSpans = [];

  const orijinalKelimeler = metin.split(/\s+/);
  targetWords.forEach((kelime, i) => {
    const span = document.createElement('span');
    span.className   = 'word' + (i === 0 ? ' active' : '');
    span.textContent = orijinalKelimeler[i] || kelime;
    span.dataset.index = i;
    fragment.appendChild(span);
    wordSpans.push(span);
  });

  wordCard.innerHTML = '';
  wordCard.appendChild(fragment);
}

// â”€â”€â”€ Kelime doÄŸrulama â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validateWord(konusulanKelime) {
  if (currentWordIndex >= targetWords.length) return;

  const tokenler = normalizeText(konusulanKelime);
  if (tokenler.length === 0) return;

  const token = tokenler[0];
  const hedef = targetWords[currentWordIndex];
  const span  = wordSpans[currentWordIndex];

  if (kelimeEslesir(token, hedef)) {
    // âœ… DoÄŸru â€” TTS YOK
    span.className = 'word correct';
    score      += 10;
    totalScore += 10;
    bolumDogru++;
    yanlisSayac = 0;   // doÄŸru olunca yanlÄ±ÅŸ sayacÄ±nÄ± sÄ±fÄ±rla
    currentWordIndex++;
    requestAnimationFrame(updateUI);

    if (currentWordIndex === targetWords.length) {
      endGame();
    }

  } else {
    // âŒ YanlÄ±ÅŸ
    yanlisSayac++;
    bolumYanlis++;
    kelimeHatalar[hedef] = (kelimeHatalar[hedef] || 0) + 1;

    if (yanlisSayac === 1) {
      // Ä°lk yanlÄ±ÅŸ: hafif sarÄ± ipucu efekti
      span.style.transform   = 'scale(1.06)';
      span.style.background  = 'rgba(255,209,102,0.18)';
      span.style.borderColor = 'var(--yellow)';
      span.style.color       = 'var(--yellow)';
      setTimeout(() => {
        if (currentWordIndex < targetWords.length && wordSpans[currentWordIndex] === span) {
          span.style.transform   = '';
          span.style.background  = '';
          span.style.borderColor = '';
          span.style.color       = '';
          span.className = 'word active';
        }
      }, 250);
    } else {
      // 2. ve sonraki yanlÄ±ÅŸ: shake animasyonu
      span.className = 'word wrong';
      setTimeout(() => {
        if (currentWordIndex < targetWords.length && wordSpans[currentWordIndex] === span) {
          span.className = 'word active';
        }
      }, 250);
    }

    // 2. yanlÄ±ÅŸta telaffuzu seslendir
    if (yanlisSayac >= 2) {
      yanlisSayac = 0;
      SpeechController.speakCorrection(hedef, { rate: 0.72, pitch: 1.05 });
    }
  }
}

// â”€â”€â”€ Rapor gÃ¶ster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gosterRapor(opts) {
  // opts: { emoji, title, subtitle, autoMs (0=manuel), onDevam, onTekrar }
  reportEmoji.textContent    = opts.emoji   || 'ğŸŒŸ';
  reportTitle.textContent    = opts.title   || 'TamamlandÄ±!';
  reportSubtitle.textContent = opts.subtitle || '';
  reportDogru.textContent    = bolumDogru;
  reportYanlis.textContent   = bolumYanlis;
  reportPuan.textContent     = score;

  // En Ã§ok hata yapÄ±lan kelimeler (max 3)
  const hatalar = Object.entries(kelimeHatalar)
    .sort((a,b) => b[1] - a[1])
    .slice(0, 3)
    .map(([k]) => k);
  if (hatalar.length > 0) {
    reportHardList.innerHTML = hatalar.map(k => `<strong>${k}</strong>`).join('  Â·  ');
    reportHardWords.style.display = 'block';
  } else {
    reportHardWords.style.display = 'none';
  }

  // ButonlarÄ± ayarla
  reportBtnRow.innerHTML = '';
  if (opts.onTekrar) {
    const btn = document.createElement('button');
    btn.className = 'report-btn secondary';
    btn.textContent = 'ğŸ”„ Tekrar Oku';
    btn.onclick = () => { kapatRapor(); opts.onTekrar(); };
    reportBtnRow.appendChild(btn);
  }
  const btnNext = document.createElement('button');
  btnNext.className = 'report-btn primary';
  btnNext.textContent = opts.nextLabel || 'â–¶ Devam';
  btnNext.onclick = () => { kapatRapor(); opts.onDevam(); };
  reportBtnRow.appendChild(btnNext);

  // Otomatik geÃ§iÅŸ timer bar
  if (opts.autoMs && opts.autoMs > 0) {
    reportTimerWrap.style.display = 'block';
    reportTimerBar.style.transition = 'none';
    reportTimerBar.style.width = '100%';
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        reportTimerBar.style.transition = `width ${opts.autoMs}ms linear`;
        reportTimerBar.style.width = '0%';
      });
    });
    const t = setTimeout(() => { kapatRapor(); opts.onDevam(); }, opts.autoMs);
    reportBtnRow.querySelectorAll('button').forEach(b => {
      b.addEventListener('click', () => clearTimeout(t), { once: true });
    });
  } else {
    reportTimerWrap.style.display = 'none';
  }

  reportOverlay.classList.add('visible');
}

function kapatRapor() {
  reportOverlay.classList.remove('visible');
}

// â”€â”€â”€ BÃ¶lÃ¼m istatistiklerini sÄ±fÄ±rla â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sifirlaIstatistik() {
  bolumDogru    = 0;
  bolumYanlis   = 0;
  kelimeHatalar = {};
}

// â”€â”€â”€ Sonraki cÃ¼mleye geÃ§ (ortak) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sonrakiCumleyeGec() {
  if (hikayeModu) {
    hikayeCumle++;
    const hikaye = HIKAYE_GRUPLARI[hikayeIndex];
    if (hikayeCumle >= hikaye.length) {
      hikayeCumle = 0;
      if (hikayeIndex < HIKAYE_GRUPLARI.length - 1) hikayeIndex++;
      else hikayeIndex = 0;
    }
    updateStoryProgress();
  } else {
    cumleIndex++;
    if (cumleIndex >= CUMLE_GRUPLARI[grupIndex].length) {
      cumleIndex = 0;
      if (grupIndex < CUMLE_GRUPLARI.length - 1) {
        grupIndex++;
        micStatus.textContent = 'ğŸŒŸ Yeni harf grubu baÅŸlÄ±yor!';
        syncLevelButtons();
      }
    }
  }
  kaydet();
}

// â”€â”€â”€ Oyun sonu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function endGame() {
  SpeechController.stopAll();

  wordSpans.forEach((span, i) => {
    if (i >= currentWordIndex && !span.classList.contains('correct')) {
      span.className = 'word wrong';
    }
  });

  congratsBanner.classList.add('visible');
  wordCard.classList.add('celebrate');
  setTimeout(() => { wordCard.classList.remove('celebrate'); }, 600);
  btnStop.disabled  = true;
  btnStart.disabled = false;
  micStatus.textContent = 'ğŸ‰ Harika iÅŸ Ã§Ä±kardÄ±n!';

  if (endGameTimer) clearTimeout(endGameTimer);

  if (hikayeModu) {
    // â”€â”€ Hikaye modunda: cÃ¼mle bitti, bir sonraki cÃ¼mleye geÃ§ (2sn otomatik)
    // Hikayenin son cÃ¼mlesi miydi? Kontrol et
    const hikaye      = HIKAYE_GRUPLARI[hikayeIndex];
    const sonCumle    = (hikayeCumle === hikaye.length - 1);

    if (sonCumle) {
      // Hikaye tamamen bitti â†’ tam rapor, manuel geÃ§iÅŸ
      endGameTimer = setTimeout(() => {
        endGameTimer = null;
        congratsBanner.classList.remove('visible');
        errorMsg.classList.remove('visible');
        btnStop.disabled  = false;
        btnStart.disabled = false;

        const dogruYuzde = bolumDogru + bolumYanlis > 0
          ? Math.round((bolumDogru / (bolumDogru + bolumYanlis)) * 100) : 100;
        const emoji = dogruYuzde >= 90 ? 'ğŸ†' : dogruYuzde >= 70 ? 'â­' : 'ğŸ’ª';

        gosterRapor({
          emoji,
          title: 'ğŸ“– Hikaye Bitti!',
          subtitle: HIKAYE_ISIMLERI[hikayeIndex] + ' Â· %' + dogruYuzde + ' doÄŸru',
          autoMs: 0,
          nextLabel: 'â–¶ Sonraki Hikaye',
          onTekrar: () => {
            // AynÄ± hikayeyi baÅŸa sar
            hikayeCumle = 0;
            sifirlaIstatistik();
            resetCumle();
          },
          onDevam: () => {
            sonrakiCumleyeGec();
            sifirlaIstatistik();
            resetCumle();
          }
        });
      }, 1200);

    } else {
      // Hikaye devam ediyor â†’ 2sn sonra otomatik geÃ§
      endGameTimer = setTimeout(() => {
        endGameTimer = null;
        congratsBanner.classList.remove('visible');
        errorMsg.classList.remove('visible');
        btnStop.disabled  = false;
        btnStart.disabled = false;
        sifirlaIstatistik();
        sonrakiCumleyeGec();
        resetCumle();
      }, 2000);
    }

  } else {
    // â”€â”€ Normal mod: cÃ¼mle bitti
    // BÃ¶lÃ¼mÃ¼n son cÃ¼mlesi miydi?
    const sonCumle = (cumleIndex === CUMLE_GRUPLARI[grupIndex].length - 1);

    if (sonCumle) {
      // BÃ¶lÃ¼m bitti â†’ rapor gÃ¶ster, 4sn otomatik geÃ§iÅŸ
      endGameTimer = setTimeout(() => {
        endGameTimer = null;
        congratsBanner.classList.remove('visible');
        errorMsg.classList.remove('visible');
        btnStop.disabled  = false;
        btnStart.disabled = false;

        const dogruYuzde = bolumDogru + bolumYanlis > 0
          ? Math.round((bolumDogru / (bolumDogru + bolumYanlis)) * 100) : 100;
        const emoji = dogruYuzde >= 90 ? 'ğŸ†' : dogruYuzde >= 70 ? 'â­' : 'ğŸ’ª';
        const bolumNo = grupIndex + 1;

        gosterRapor({
          emoji,
          title: bolumNo + '. BÃ¶lÃ¼m TamamlandÄ±!',
          subtitle: 'Harika iÅŸ Ã§Ä±kardÄ±n! %' + dogruYuzde + ' doÄŸru',
          autoMs: 5000,
          nextLabel: 'â–¶ Sonraki BÃ¶lÃ¼m',
          onDevam: () => {
            sonrakiCumleyeGec();
            sifirlaIstatistik();
            resetCumle();
          }
        });
      }, 1200);

    } else {
      // Normal cÃ¼mle geÃ§iÅŸi
      endGameTimer = setTimeout(() => {
        endGameTimer = null;
        congratsBanner.classList.remove('visible');
        errorMsg.classList.remove('visible');
        btnStop.disabled  = false;
        btnStart.disabled = false;
        sifirlaIstatistik();
        sonrakiCumleyeGec();
        resetCumle();
      }, 2000);
    }
  }
}

// â”€â”€â”€ CÃ¼mle sÄ±fÄ±rla ve baÅŸlat (ortak) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetCumle() {
  currentWordIndex   = 0;
  score              = 0;
  processedWordCount = 0;
  yanlisSayac        = 0;
  interimText.textContent  = '';
  congratsBanner.classList.remove('visible');
  errorMsg.classList.remove('visible');
  oyunuKur();
  SpeechController.startListening();
}

// â”€â”€â”€ Hata mesajÄ± gÃ¶ster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gosterHata(mesaj) {
  errorMsg.textContent = mesaj;
  errorMsg.classList.add('visible');
}

// â”€â”€â”€ Buton iÅŸleyicileri â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnStart.addEventListener('click', () => {
  if (!SpeechRecognition) return;
  if (SpeechController.isListening()) return;

  btnStart.disabled = false;
  btnStop.disabled  = false;

  if (endGameTimer) { clearTimeout(endGameTimer); endGameTimer = null; }
  kapatRapor();
  sifirlaIstatistik();
  currentWordIndex   = 0;
  score              = 0;
  processedWordCount = 0;
  yanlisSayac        = 0;
  interimText.textContent  = '';
  congratsBanner.classList.remove('visible');
  errorMsg.classList.remove('visible');

  SpeechController.stopAll();
  oyunuKur();
  SpeechController.startListening();
});

btnStop.addEventListener('click', () => {
  SpeechController.stopAll();
  setTimeout(() => { btnStart.click(); }, 250);
});

btnSkip.addEventListener('click', () => {
  if (endGameTimer) { clearTimeout(endGameTimer); endGameTimer = null; }
  SpeechController.stopAll();
  kapatRapor();
  sifirlaIstatistik();
  sonrakiCumleyeGec();
  currentWordIndex   = 0;
  score              = 0;
  processedWordCount = 0;
  yanlisSayac        = 0;
  interimText.textContent  = '';
  congratsBanner.classList.remove('visible');
  errorMsg.classList.remove('visible');
  oyunuKur();
  setTimeout(() => { btnStart.click(); }, 250);
});

// â”€â”€â”€ Seviye butonlarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncLevelButtons() {
  document.querySelectorAll('.lvl-btn').forEach(btn => {
    const aktif = !hikayeModu && parseInt(btn.dataset.level) === grupIndex;
    btn.classList.toggle('active', aktif);
    btn.style.opacity = hikayeModu ? '0.25' : '';
  });
  tabAlistirma.classList.toggle('active', !hikayeModu);
  tabHikaye.classList.toggle('active', hikayeModu);
}

document.querySelectorAll('.lvl-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (hikayeModu) return;
    const secilenGrup = parseInt(btn.dataset.level);
    if (secilenGrup === grupIndex) return;
    if (endGameTimer) { clearTimeout(endGameTimer); endGameTimer = null; }
    SpeechController.stopAll();
    kapatRapor();
    sifirlaIstatistik();
    grupIndex          = secilenGrup;
    cumleIndex         = 0;
    currentWordIndex   = 0;
    score              = 0;
    processedWordCount = 0;
    yanlisSayac        = 0;
    interimText.textContent  = '';
    congratsBanner.classList.remove('visible');
    errorMsg.classList.remove('visible');
    syncLevelButtons();
    oyunuKur();
    kaydet();
    setTimeout(() => { btnStart.click(); }, 250);
  });
});

// â”€â”€â”€ Hikaye navigasyon butonlarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hikayeSecGit(hedefIndex) {
  if (!hikayeModu) return;
  if (endGameTimer) { clearTimeout(endGameTimer); endGameTimer = null; }
  SpeechController.stopAll();
  kapatRapor();
  sifirlaIstatistik();
  hikayeIndex        = ((hedefIndex % HIKAYE_GRUPLARI.length) + HIKAYE_GRUPLARI.length) % HIKAYE_GRUPLARI.length;
  hikayeCumle        = 0;
  currentWordIndex   = 0;
  score              = 0;
  processedWordCount = 0;
  yanlisSayac        = 0;
  interimText.textContent = '';
  congratsBanner.classList.remove('visible');
  errorMsg.classList.remove('visible');
  updateStoryProgress();
  kaydet();
  oyunuKur();
  setTimeout(() => { btnStart.click(); }, 250);
}

btnHikayeGeri.addEventListener('click',  () => hikayeSecGit(hikayeIndex - 1));
btnHikayeIleri.addEventListener('click', () => hikayeSecGit(hikayeIndex + 1));

// â”€â”€â”€ Hikaye ilerleme UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStoryProgress() {
  if (!hikayeModu) return;
  const hikaye = HIKAYE_GRUPLARI[hikayeIndex];
  const toplam = hikaye.length;
  const yuzde  = Math.round((hikayeCumle / toplam) * 100);
  storyTitle.textContent        = 'ğŸ“– ' + HIKAYE_ISIMLERI[hikayeIndex];
  storyBar.style.width          = yuzde + '%';
  storyProgressText.textContent = (hikayeCumle + 1) + ' / ' + toplam;
}

// â”€â”€â”€ Sekme butonlarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMod(hikaye) {
  if (hikayeModu === hikaye) return;
  if (endGameTimer) { clearTimeout(endGameTimer); endGameTimer = null; }
  SpeechController.stopAll();
  kapatRapor();
  sifirlaIstatistik();
  hikayeModu = hikaye;
  if (hikayeModu) {
    hikayeIndex = 0;
    hikayeCumle = 0;
    storyProgress.classList.add('visible');
    updateStoryProgress();
  } else {
    storyProgress.classList.remove('visible');
  }
  currentWordIndex   = 0;
  score              = 0;
  processedWordCount = 0;
  yanlisSayac        = 0;
  interimText.textContent  = '';
  congratsBanner.classList.remove('visible');
  errorMsg.classList.remove('visible');
  syncLevelButtons();
  oyunuKur();
  kaydet();
  setTimeout(() => { btnStart.click(); }, 250);
}

tabAlistirma.addEventListener('click', () => setMod(false));
tabHikaye.addEventListener('click',    () => setMod(true));

// â”€â”€â”€ Ses seviyesi â†’ mic daire efekti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function () {
  let audioCtx = null, analyser = null, dataArr = null, rafId = null;

  function startAnalyser(stream) {
    if (audioCtx) return;
    audioCtx  = new (window.AudioContext || window.webkitAudioContext)();
    analyser  = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    dataArr   = new Uint8Array(analyser.frequencyBinCount);
    audioCtx.createMediaStreamSource(stream).connect(analyser);
    tick();
  }

  function tick() {
    rafId = requestAnimationFrame(tick);
    analyser.getByteFrequencyData(dataArr);
    const avg   = dataArr.reduce((s, v) => s + v, 0) / dataArr.length;
    const level = Math.min(avg / 60, 1);           // 0â€“1 arasÄ± normalize
    const scale = 1 + level * 0.45;                // max 1.45x bÃ¼yÃ¼r
    const glow  = Math.round(level * 32);           // max 32px glow
    micIndicator.style.transform  = `scale(${scale.toFixed(2)})`;
    micIndicator.style.boxShadow  = `0 0 ${glow}px rgba(6,214,160,${(level * 0.8).toFixed(2)})`;
  }

  function stopAnalyser() {
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
    micIndicator.style.transform = '';
    micIndicator.style.boxShadow = '';
    if (audioCtx) { audioCtx.close(); audioCtx = null; analyser = null; }
  }

  // Mikrofon izni alÄ±nÄ±nca baÅŸlat
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => { startAnalyser(stream); })
      .catch(() => {});  // izin reddedilirse sessizce geÃ§
  }
})();

// â”€â”€â”€ Ä°lk yÃ¼kleme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
yukle();   // localStorage'dan kaldÄ±ÄŸÄ± yeri yÃ¼kle
syncLevelButtons();
// storyProgress sadece hikaye modundaysa gÃ¶rÃ¼nÃ¼r
storyProgress.classList.toggle('visible', hikayeModu);
if (hikayeModu) updateStoryProgress();
oyunuKur();
</script>
</body>
</html>
