<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sesli Okuma Oyunu</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1b2d;
    --surface: #1a2d46;
    --surface2: #223558;
    --accent: #ffd166;
    --accent2: #06d6a0;
    --red: #ef476f;
    --green: #06d6a0;
    --yellow: #ffd166;
    --blue: #118ab2;
    --text: #e8f4fd;
    --text-muted: #7fa8c9;
    --radius: 20px;
    --shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Baloo 2', cursive;
    background: var(--bg);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }

  .stars {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
  }
  .star {
    position: absolute;
    border-radius: 50%;
    background: white;
    animation: twinkle var(--d, 3s) ease-in-out infinite;
    animation-delay: var(--delay, 0s);
    opacity: 0.3;
  }
  @keyframes twinkle {
    0%, 100% { opacity: 0.1; transform: scale(0.8); }
    50% { opacity: 0.7; transform: scale(1.2); }
  }

  .game-container {
    position: relative;
    z-index: 1;
    width: min(90vw, 640px);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 24px;
  }

  .title-area { text-align: center; }
  .title-area h1 {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(1.8rem, 6vw, 3rem);
    color: var(--accent);
    text-shadow: 0 0 20px rgba(255,209,102,0.4), 0 4px 8px rgba(0,0,0,0.5);
    letter-spacing: -0.5px;
  }
  .subtitle {
    font-size: 0.95rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .score-card {
    background: var(--surface);
    border: 2px solid var(--surface2);
    border-radius: var(--radius);
    padding: 12px 32px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: var(--shadow);
  }
  .score-icon { font-size: 1.6rem; }
  .score-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .score-value {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 2rem;
    color: var(--accent);
    line-height: 1;
    transition: transform 0.15s ease;
  }
  .score-value.bump { animation: scoreBump 0.3s ease; }
  @keyframes scoreBump {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); color: #fff; }
    100% { transform: scale(1); }
  }

  .word-card {
    background: var(--surface);
    border: 2px solid var(--surface2);
    border-radius: var(--radius);
    padding: 36px 40px;
    width: 100%;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    min-height: 120px;
  }

  .word {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(2rem, 8vw, 3.5rem);
    padding: 8px 18px;
    border-radius: 14px;
    border: 3px solid transparent;
    transition: all 0.25s ease;
    cursor: default;
    letter-spacing: 0.5px;
    color: var(--text);
    background: transparent;
  }
  .word.active {
    background: rgba(255, 209, 102, 0.15);
    border-color: var(--yellow);
    color: var(--yellow);
    transform: scale(1.08);
    box-shadow: 0 0 20px rgba(255,209,102,0.3);
    animation: pulse 1.2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 20px rgba(255,209,102,0.3); }
    50% { box-shadow: 0 0 36px rgba(255,209,102,0.6); }
  }
  .word.correct {
    background: rgba(6, 214, 160, 0.15);
    border-color: var(--green);
    color: var(--green);
    animation: correctPop 0.4s ease forwards;
  }
  @keyframes correctPop {
    0% { transform: scale(1); }
    40% { transform: scale(1.15) rotate(-2deg); }
    70% { transform: scale(0.97) rotate(1deg); }
    100% { transform: scale(1) rotate(0deg); }
  }
  .word.wrong {
    background: rgba(239, 71, 111, 0.15);
    border-color: var(--red);
    color: var(--red);
    animation: shake 0.25s ease;
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(6px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
  }

  .mic-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  .mic-indicator {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--surface);
    border: 3px solid var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
  }
  .mic-indicator.active {
    background: rgba(239, 71, 111, 0.15);
    border-color: var(--red);
    animation: micPulse 1s ease-in-out infinite;
  }
  /* TTS konuÅŸurken gÃ¶sterge */
  .mic-indicator.speaking {
    background: rgba(255, 209, 102, 0.15);
    border-color: var(--yellow);
    animation: speakPulse 0.8s ease-in-out infinite;
  }
  @keyframes micPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 71, 111, 0.4); }
    50% { box-shadow: 0 0 0 16px rgba(239, 71, 111, 0); }
  }
  @keyframes speakPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255, 209, 102, 0.4); }
    50% { box-shadow: 0 0 0 16px rgba(255, 209, 102, 0); }
  }
  .mic-status {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-align: center;
    min-height: 20px;
    transition: color 0.3s;
  }
  .mic-status.listening { color: var(--red); }
  .mic-status.speaking  { color: var(--yellow); }

  .interim-text {
    font-size: 0.9rem;
    color: var(--text-muted);
    font-style: italic;
    min-height: 22px;
    text-align: center;
    max-width: 400px;
    transition: opacity 0.2s;
  }

  .button-row { display: flex; gap: 16px; }
  .btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.1rem;
    padding: 14px 36px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 14px rgba(0,0,0,0.3);
    letter-spacing: 0.5px;
  }
  .btn:active { transform: scale(0.96); }
  .btn-start {
    background: linear-gradient(135deg, var(--green), #04b88a);
    color: #0a2a1f;
  }
  .btn-start:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(6,214,160,0.4);
  }
  .btn-stop {
    background: linear-gradient(135deg, var(--red), #d63060);
    color: #000;
  }
  .btn-stop:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239,71,111,0.4);
  }
  .btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none;
  }

  .congrats-banner {
    display: none;
    background: linear-gradient(135deg, #ffd166, #ff9f1c);
    color: #1a0a00;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(1.4rem, 5vw, 2rem);
    padding: 18px 40px;
    border-radius: var(--radius);
    text-align: center;
    width: 100%;
    box-shadow: 0 8px 32px rgba(255,209,102,0.5);
    animation: congratsIn 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
  }
  @keyframes congratsIn {
    0% { transform: scale(0.5) rotate(-4deg); opacity: 0; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
  }
  .congrats-banner.visible { display: block; }

  .error-msg {
    display: none;
    color: var(--red);
    font-size: 0.9rem;
    text-align: center;
    background: rgba(239,71,111,0.1);
    border: 1px solid rgba(239,71,111,0.3);
    border-radius: 12px;
    padding: 10px 20px;
    width: 100%;
  }
  .error-msg.visible { display: block; }

  .no-support {
    display: none;
    color: var(--accent);
    text-align: center;
    font-size: 1.1rem;
    padding: 20px;
  }
  .no-support.visible { display: block; }
</style>
</head>
<body>

<div class="stars" id="stars"></div>

<div class="game-container" id="gameContainer">

  <div class="title-area">
    <h1>ğŸŒŸ Sesli Okuma Oyunu</h1>
    <p class="subtitle">Kelimeyi sesli oku ve puan kazan!</p>
  </div>

  <div class="score-card">
    <span class="score-icon">â­</span>
    <div>
      <div class="score-label">Puan</div>
      <div class="score-value" id="scoreDisplay">0</div>
    </div>
  </div>

  <div class="word-card" id="wordCard"></div>

  <div class="mic-area">
    <div class="mic-indicator" id="micIndicator">ğŸ¤</div>
    <div class="mic-status" id="micStatus">BaÅŸlamak iÃ§in dÃ¼ÄŸmeye bas</div>
  </div>

  <div class="interim-text" id="interimText"></div>

  <div class="button-row">
    <button class="btn btn-start" id="btnStart">â–¶ BaÅŸla</button>
    <button class="btn btn-stop" id="btnStop" disabled>ğŸ”„ Tekrar</button>
  </div>

  <div class="congrats-banner" id="congratsBanner">
    ğŸ‰ Tebrikler! Harika okudun! ğŸ‰
  </div>

  <div class="error-msg" id="errorMsg"></div>

  <div class="no-support" id="noSupport">
    ğŸ˜” ÃœzgÃ¼nÃ¼m, tarayÄ±cÄ±n sesli tanÄ±ma Ã¶zelliÄŸini desteklemiyor. LÃ¼tfen Google Chrome kullan.
  </div>

</div>

<script>
"use strict";

// â”€â”€â”€ YÄ±ldÄ±z arka planÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function yaratYildizlar() {
  const starsEl  = document.getElementById('stars');
  const fragment = document.createDocumentFragment();
  for (let i = 0; i < 80; i++) {
    const s    = document.createElement('div');
    s.className = 'star';
    const boyut = Math.random() * 3 + 1;
    s.style.cssText = `width:${boyut}px;height:${boyut}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${2+Math.random()*4}s;--delay:${Math.random()*5}s;`;
    fragment.appendChild(s);
  }
  starsEl.appendChild(fragment);
})();

// â”€â”€â”€ TarayÄ±cÄ± desteÄŸi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

// â”€â”€â”€ DOM referanslarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const btnStart       = document.getElementById('btnStart');
const btnStop        = document.getElementById('btnStop');
const wordCard       = document.getElementById('wordCard');
const scoreDisplay   = document.getElementById('scoreDisplay');
const micIndicator   = document.getElementById('micIndicator');
const micStatus      = document.getElementById('micStatus');
const interimText    = document.getElementById('interimText');
const congratsBanner = document.getElementById('congratsBanner');
const errorMsg       = document.getElementById('errorMsg');
const noSupport      = document.getElementById('noSupport');

if (!SpeechRecognition) {
  noSupport.classList.add('visible');
  btnStart.disabled = true;
}

// â”€â”€â”€ Hedef metin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HEDEF_METIN = "Ali topu at";

// â”€â”€â”€ Oyun durumu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let targetWords        = [];
let wordSpans          = [];
let currentWordIndex   = 0;
let score              = 0;
let processedWordCount = 0;
let yanlisSayac        = 0;   // yanlÄ±ÅŸ telaffuz sayacÄ± (TTS tetikleme iÃ§in)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SpeechController
// Tek sorumluluk: TTS ve Recognition lifecycle'Ä±nÄ± Ã§akÄ±ÅŸmasÄ±z yÃ¶netmek.
//
// KURAL: TTS aktifken Recognition kapalÄ±.
//        Recognition aktifken TTS baÅŸlatÄ±lamaz.
//        TTS yalnÄ±zca yanlÄ±ÅŸ telaffuzda dÄ±ÅŸarÄ±dan tetiklenir.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SpeechController = (function () {

  // â”€â”€ Ä°Ã§ durum â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let recognition   = null;
  let recState      = 'idle';   // 'idle' | 'starting' | 'listening' | 'stopping'
  let isSpeaking    = false;
  let lastError     = null;
  let silenceTimer  = null;
  let restartTimer  = null;
  let watchdogTimer = null;   // recognition sessizce dÃ¼ÅŸtÃ¼yse yakalar
  let trVoiceCache  = null;

  // â”€â”€ TÃ¼rkÃ§e ses seÃ§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getTrVoice() {
    if (trVoiceCache) return trVoiceCache;
    const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
    trVoiceCache = voices.find(v => v.lang === 'tr-TR' && v.localService)
                || voices.find(v => v.lang === 'tr-TR')
                || null;
    return trVoiceCache;
  }
  if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = () => { trVoiceCache = null; getTrVoice(); };
  }

  // â”€â”€ Timer yardÄ±mcÄ±larÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clearTimers() {
    if (silenceTimer)  { clearTimeout(silenceTimer);  silenceTimer  = null; }
    if (restartTimer)  { clearTimeout(restartTimer);  restartTimer  = null; }
    if (watchdogTimer) { clearTimeout(watchdogTimer); watchdogTimer = null; }
  }

  // Watchdog: recognition sessizce dÃ¼ÅŸtÃ¼yse 3sn iÃ§inde yakalar ve restart yapar
  function resetWatchdog() {
    if (watchdogTimer) clearTimeout(watchdogTimer);
    watchdogTimer = setTimeout(() => {
      watchdogTimer = null;
      if (isSpeaking) return;
      if (currentWordIndex >= targetWords.length) return;
      if (recState !== 'listening') {
        // Recognition ayakta deÄŸil, yeniden baÅŸlat
        scheduleRestart(100);
      } else {
        // Ayakta gÃ¶rÃ¼nÃ¼yor ama emin olmak iÃ§in watchdog'u yenile
        resetWatchdog();
      }
    }, 3000);
  }

  function scheduleRestart(ms) {
    if (restartTimer) clearTimeout(restartTimer);
    restartTimer = setTimeout(() => {
      restartTimer = null;
      if (!isSpeaking && recState === 'idle') _start();
    }, ms || 300);
  }

  function resetSilenceTimer() {
    if (silenceTimer) clearTimeout(silenceTimer);
    if (recState !== 'listening') return;
    silenceTimer = setTimeout(() => {
      if (recState === 'listening' && !isSpeaking && currentWordIndex < targetWords.length) {
        _stop(true); // sessizlik â†’ restart
      }
    }, 1800);
  }

  // â”€â”€ Recognition iÃ§ inÅŸa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function _build() {
    if (!SpeechRecognition) return;
    if (recognition) {
      recognition.onresult = null;
      recognition.onerror  = null;
      recognition.onend    = null;
      try { recognition.abort(); } catch (e) {}
      recognition = null;
    }
    recognition = new SpeechRecognition();
    recognition.lang            = 'tr-TR';
    recognition.continuous      = true;
    recognition.interimResults  = true;
    recognition.maxAlternatives = 5;
    recognition.onstart  = _onStart;
    recognition.onresult = _onResult;
    recognition.onerror  = _onError;
    recognition.onend    = _onEnd;
  }

  // â”€â”€ Recognition event handler'larÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function _onStart() {
    // Recognition gerÃ§ekten baÅŸladÄ± â€” state'i gÃ¼venle otur
    recState = 'listening';
    resetWatchdog();
    micIndicator.className = 'mic-indicator active';
    micStatus.className    = 'mic-status listening';
    micStatus.textContent  = 'ğŸ¤ Dinliyorum...';
  }
  function _onResult(event) {
    if (!event || !event.results) return;
    if (isSpeaking) return;   // TTS aktifken echo korumasÄ±

    resetWatchdog();   // ses geldi â†’ recognition ayakta, watchdog'u yenile
    interimText.textContent = event.results[event.results.length - 1][0].transcript;
    resetSilenceTimer();

    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (!event.results[i].isFinal) continue;
      if (currentWordIndex < targetWords.length) {
        const enIyi = checkAlternatives(event.results[i]);
        if (enIyi) validateWord(enIyi);
      }
    }
  }

  function _onError(event) {
    lastError = event.error;
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      gosterHata('Mikrofon izni reddedildi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±ndan izin ver.');
      recState = 'idle';
      btnStart.disabled = false;
      btnStop.disabled  = true;
    } else if (event.error === 'network') {
      gosterHata('AÄŸ hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ± kontrol et.');
    }
    // 'no-speech', 'aborted' â†’ _onEnd yÃ¶netir
  }

  function _onEnd() {
    if (recState === 'stopping') { recState = 'idle'; return; }
    if (lastError === 'not-allowed' || lastError === 'service-not-allowed') { recState = 'idle'; return; }
    recState = 'idle';

    // TTS aktifse veya oyun bitmiÅŸse restart yok
    if (isSpeaking) return;
    if (currentWordIndex >= targetWords.length) return;

    scheduleRestart(300);
  }

  // â”€â”€ Ä°Ã§ start/stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function _start() {
    if (!SpeechRecognition) return;
    if (recState === 'starting' || recState === 'listening') return;
    if (isSpeaking) return;
    if (lastError === 'not-allowed' || lastError === 'service-not-allowed') return;

    errorMsg.classList.remove('visible');
    lastError = null;
    _build();
    recState = 'starting';

    try {
      recognition.start();
      recState = 'starting';
      // micIndicator ve micStatus â†’ _onStart'ta gÃ¼ncellenir
      interimText.textContent = '';
    } catch (e) {
      recState = 'idle';
      if (e.name === 'InvalidStateError') {
        scheduleRestart(500);
      } else {
        gosterHata('Mikrofon baÅŸlatÄ±lamadÄ±: ' + e.message);
      }
    }
  }

  function _stop(andRestart) {
    clearTimers();
    if (recState === 'idle') return;
    recState = 'stopping';
    if (recognition) { try { recognition.stop(); } catch (e) {} }
    micIndicator.className = 'mic-indicator';
    micStatus.className    = 'mic-status';
    micStatus.textContent  = 'BaÅŸlamak iÃ§in dÃ¼ÄŸmeye bas';
    interimText.textContent = '';
    // _onEnd â†’ recState = 'idle' â†’ scheduleRestart varsa Ã§alÄ±ÅŸÄ±r
    if (andRestart) {
      // _onEnd iÃ§inde zaten scheduleRestart Ã§aÄŸrÄ±lacak
    }
  }

  // â”€â”€ Public API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return {

    /**
     * BaÅŸlat â€” oyun baÅŸlangÄ±cÄ± veya Tekrar butonunda Ã§aÄŸrÄ±lÄ±r.
     */
    startListening() {
      lastError = null;
      resetWatchdog();
      scheduleRestart(100);
    },

    /**
     * TTS ile yanlÄ±ÅŸ kelimeyi sÃ¶yle.
     * Ã‡aÄŸrÄ±lmadan Ã¶nce Recognition otomatik durdurulur.
     * TTS bitince Recognition otomatik yeniden baÅŸlar.
     * SADECE yanlÄ±ÅŸ telaffuzda dÄ±ÅŸarÄ±dan Ã§aÄŸrÄ±lmalÄ±.
     */
    speakCorrection(metin, opts) {
      if (!window.speechSynthesis) return;
      opts = opts || {};
      const rate  = opts.rate  || 0.80;
      const pitch = opts.pitch || 1.05;

      // Ã–nce TTS iptal, sonra Recognition durdur
      window.speechSynthesis.cancel();
      if (recState !== 'idle') _stop(false);
      clearTimers();

      isSpeaking = true;
      micIndicator.className = 'mic-indicator speaking';
      micStatus.className    = 'mic-status speaking';
      micStatus.textContent  = 'ğŸ”Š Dinle...';
      interimText.textContent = '';

      const ut    = new SpeechSynthesisUtterance(metin);
      ut.lang     = 'tr-TR';
      ut.rate     = rate;
      ut.pitch    = pitch;
      ut.volume   = 1;
      const voice = getTrVoice();
      if (voice) ut.voice = voice;

      ut.onend = () => {
        isSpeaking = false;
        micIndicator.className = 'mic-indicator';
        micStatus.className    = 'mic-status';
        micStatus.textContent  = '';
        // Oyun bitmemiÅŸse mikrofonu yeniden aÃ§
        if (currentWordIndex < targetWords.length) {
          scheduleRestart(250);
        }
      };

      ut.onerror = () => {
        isSpeaking = false;
        micIndicator.className = 'mic-indicator';
        micStatus.className    = 'mic-status';
        if (currentWordIndex < targetWords.length) scheduleRestart(300);
      };

      window.speechSynthesis.speak(ut);
    },

    /**
     * Her ÅŸeyi durdur â€” sÄ±fÄ±rlama veya oyun sonu.
     */
    stopAll() {
      isSpeaking = false;
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      clearTimers();
      if (recState !== 'idle') {
        recState = 'stopping';
        if (recognition) { try { recognition.stop(); } catch (e) {} }
      }
      micIndicator.className = 'mic-indicator';
      micStatus.className    = 'mic-status';
      micStatus.textContent  = 'BaÅŸlamak iÃ§in dÃ¼ÄŸmeye bas';
      interimText.textContent = '';
    },

    isSpeaking() { return isSpeaking; },
    isListening() { return recState === 'listening'; }
  };
})();

// â”€â”€â”€ TÃ¼rkÃ§e normalizasyon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeText(metin) {
  if (!metin || typeof metin !== 'string') return [];
  let sonuc = metin.replace(/I/g, 'Ä±').replace(/Ä°/g, 'i').toLocaleLowerCase('tr-TR');
  sonuc = sonuc.replace(/[^\p{L}\s]/gu, '');
  return sonuc.split(/\s+/).filter(t => t.length > 0);
}

// â”€â”€â”€ Levenshtein mesafesi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function levenshtein(a, b) {
  const m = a.length, n = b.length;
  if (m === 0) return n;
  if (n === 0) return m;
  const dp = [];
  for (let i = 0; i <= m; i++) dp[i] = [i];
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      dp[i][j] = a[i-1] === b[j-1]
        ? dp[i-1][j-1]
        : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
    }
  }
  return dp[m][n];
}

// â”€â”€â”€ ToleranslÄ± eÅŸleÅŸme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function kelimeEslesir(konusulan, hedef) {
  if (konusulan === hedef) return true;
  const dist    = levenshtein(konusulan, hedef);
  const maxLen  = Math.max(hedef.length, konusulan.length);
  let tolerans;
  if (hedef.length <= 3)      tolerans = 1;
  else if (hedef.length <= 6) tolerans = 2;
  else                        tolerans = 3;
  return dist <= Math.min(tolerans, Math.floor(maxLen * 0.40));
}

// â”€â”€â”€ TÃ¼m alternatifleri kontrol et â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkAlternatives(result) {
  for (let a = 0; a < result.length; a++) {
    const tokenler = normalizeText(result[a].transcript);
    if (tokenler.length === 0) continue;
    if (kelimeEslesir(tokenler[0], targetWords[currentWordIndex])) return tokenler[0];
  }
  return normalizeText(result[0].transcript)[0] || '';
}

// â”€â”€â”€ UI gÃ¼ncelle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUI() {
  wordSpans.forEach((span, i) => {
    if (i === currentWordIndex && !span.classList.contains('correct') && !span.classList.contains('wrong')) {
      span.className = 'word active';
    }
  });

  const eskiPuan = parseInt(scoreDisplay.textContent, 10);
  scoreDisplay.textContent = score;
  if (score !== eskiPuan) {
    scoreDisplay.classList.remove('bump');
    void scoreDisplay.offsetWidth;
    scoreDisplay.classList.add('bump');
  }
}

// â”€â”€â”€ Oyunu kur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function oyunuKur() {
  targetWords = normalizeText(HEDEF_METIN);
  const fragment = document.createDocumentFragment();
  wordSpans = [];

  const orijinalKelimeler = HEDEF_METIN.split(/\s+/);
  targetWords.forEach((kelime, i) => {
    const span = document.createElement('span');
    span.className   = 'word' + (i === 0 ? ' active' : '');
    span.textContent = orijinalKelimeler[i] || kelime;
    span.dataset.index = i;
    fragment.appendChild(span);
    wordSpans.push(span);
  });

  wordCard.innerHTML = '';
  wordCard.appendChild(fragment);
}

// â”€â”€â”€ Kelime doÄŸrulama â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validateWord(konusulanKelime) {
  if (currentWordIndex >= targetWords.length) return;

  const tokenler = normalizeText(konusulanKelime);
  if (tokenler.length === 0) return;

  const token = tokenler[0];
  const hedef = targetWords[currentWordIndex];
  const span  = wordSpans[currentWordIndex];

  if (kelimeEslesir(token, hedef)) {
    // âœ… DoÄŸru â€” TTS YOK
    span.className = 'word correct';
    score += 10;
    yanlisSayac = 0;   // doÄŸru olunca yanlÄ±ÅŸ sayacÄ±nÄ± sÄ±fÄ±rla
    currentWordIndex++;
    requestAnimationFrame(updateUI);

    if (currentWordIndex === targetWords.length) {
      endGame();
    }

  } else {
    // âŒ YanlÄ±ÅŸ
    yanlisSayac++;

    if (yanlisSayac === 1) {
      // Ä°lk yanlÄ±ÅŸ: hafif sarÄ± ipucu efekti
      span.style.transform   = 'scale(1.06)';
      span.style.background  = 'rgba(255,209,102,0.18)';
      span.style.borderColor = 'var(--yellow)';
      span.style.color       = 'var(--yellow)';
      setTimeout(() => {
        if (currentWordIndex < targetWords.length && wordSpans[currentWordIndex] === span) {
          span.style.transform   = '';
          span.style.background  = '';
          span.style.borderColor = '';
          span.style.color       = '';
          span.className = 'word active';
        }
      }, 250);
    } else {
      // 2. ve sonraki yanlÄ±ÅŸ: shake animasyonu
      span.className = 'word wrong';
      setTimeout(() => {
        if (currentWordIndex < targetWords.length && wordSpans[currentWordIndex] === span) {
          span.className = 'word active';
        }
      }, 250);
    }

    // 2. yanlÄ±ÅŸta telaffuzu seslendir
    if (yanlisSayac >= 2) {
      yanlisSayac = 0;
      SpeechController.speakCorrection(hedef, { rate: 0.72, pitch: 1.05 });
    }
  }
}

// â”€â”€â”€ Oyun sonu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function endGame() {
  SpeechController.stopAll();

  wordSpans.forEach((span, i) => {
    if (i >= currentWordIndex && !span.classList.contains('correct')) {
      span.className = 'word wrong';
    }
  });

  congratsBanner.classList.add('visible');
  btnStop.disabled  = true;
  btnStart.disabled = false;
  micStatus.textContent = 'ğŸ‰ Harika iÅŸ Ã§Ä±kardÄ±n!';

  // 2 saniye sonra otomatik yeniden baÅŸlat
  setTimeout(() => { btnStart.click(); }, 2000);
}

// â”€â”€â”€ Hata mesajÄ± gÃ¶ster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gosterHata(mesaj) {
  errorMsg.textContent = mesaj;
  errorMsg.classList.add('visible');
}

// â”€â”€â”€ Buton iÅŸleyicileri â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnStart.addEventListener('click', () => {
  if (!SpeechRecognition) return;
  if (SpeechController.isListening()) return;

  btnStart.disabled = false;
  btnStop.disabled  = false;

  currentWordIndex   = 0;
  score              = 0;
  processedWordCount = 0;
  yanlisSayac        = 0;
  scoreDisplay.textContent = '0';
  interimText.textContent  = '';
  congratsBanner.classList.remove('visible');
  errorMsg.classList.remove('visible');

  SpeechController.stopAll();
  oyunuKur();
  SpeechController.startListening();
});

btnStop.addEventListener('click', () => {
  SpeechController.stopAll();
  setTimeout(() => { btnStart.click(); }, 250);
});

// â”€â”€â”€ Ä°lk yÃ¼kleme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
oyunuKur();
</script>
</body>
</html>
